<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ThreadCal Pro v4 â€” ISO 17025</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: { extend: { fontFamily: { sans: ["DM Sans","system-ui","sans-serif"], mono: ["DM Mono","monospace"] } } }
}
</script>
<style>
* { -webkit-font-smoothing: antialiased; }
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:#f1f5f9; }
::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }
@media print {
  aside, .no-print { display:none !important; }
  body { background:white !important; }
  main { padding:0 !important; }
}
</style>
</head>
<body class="bg-slate-50">
<div id="root"></div>
<script type="text/babel" data-presets="react">
const { useState, useEffect, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
get: (k) => { try { const v = localStorage.getItem(â€œtc4_â€+k); return v ? JSON.parse(v) : null; } catch { return null; } },
set: (k, v) => { try { localStorage.setItem(â€œtc4_â€+k, JSON.stringify(v)); } catch {} },
del: (k) => { try { localStorage.removeItem(â€œtc4_â€+k); } catch {} },
};
const uid = () => Math.random().toString(36).slice(2, 9) + Date.now().toString(36).slice(-4);
const today = () => new Date().toISOString().slice(0, 10);
const fmtDate = (d) => d ? new Date(d + â€˜T12:00:00â€™).toLocaleDateString(â€˜es-ESâ€™, { day: â€˜2-digitâ€™, month: â€˜2-digitâ€™, year: â€˜numericâ€™ }) : â€˜â€”â€™;
const fmt = (v, dec = 5) => (v == null || isNaN(v)) ? â€˜â€”â€™ : Math.abs(v) < 0.001 && v !== 0 ? v.toExponential(3) : (+v).toFixed(dec);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREAD DATABASE â€” full ISO/ASME coverage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THREAD_STANDARDS = [
{ id: â€˜Mâ€™, label: â€˜MÃ©trica ISOâ€™, norm: â€˜ISO 68-1 / ISO 724 / ISO 965â€™, alpha: 60, tolExt: â€˜6gâ€™, tolInt: â€˜6Hâ€™ },
{ id: â€˜UNCâ€™, label: â€˜UNCâ€™, norm: â€˜ASME B1.1â€™, alpha: 60, tolExt: â€˜2Aâ€™, tolInt: â€˜2Bâ€™ },
{ id: â€˜UNFâ€™, label: â€˜UNFâ€™, norm: â€˜ASME B1.1â€™, alpha: 60, tolExt: â€˜2Aâ€™, tolInt: â€˜2Bâ€™ },
{ id: â€˜BSWâ€™, label: â€˜Whitworth BSWâ€™, norm: â€˜BS 84â€™, alpha: 55, tolExt: â€˜mediumâ€™, tolInt: â€˜mediumâ€™ },
{ id: â€˜BSFâ€™, label: â€˜Whitworth BSFâ€™, norm: â€˜BS 84â€™, alpha: 55, tolExt: â€˜mediumâ€™, tolInt: â€˜mediumâ€™ },
{ id: â€˜Trâ€™, label: â€˜Trapezoidal ISOâ€™, norm: â€˜ISO 2903â€™, alpha: 30, tolExt: â€˜7eâ€™, tolInt: â€˜7Hâ€™ },
{ id: â€˜ACMEâ€™, label: â€˜ACMEâ€™, norm: â€˜ASME B1.5â€™, alpha: 29, tolExt: â€˜2Gâ€™, tolInt: â€˜2Gâ€™ },
{ id: â€˜NPTâ€™, label: â€˜Pipe NPTâ€™, norm: â€˜ASME B1.20.1â€™, alpha: 60, tolExt: â€˜L1â€™, tolInt: â€˜L1â€™ },
{ id: â€˜BSPPâ€™, label: â€˜BSP CilÃ­ndricaâ€™, norm: â€˜ISO 228-1â€™, alpha: 55, tolExt: â€˜Aâ€™, tolInt: â€˜Bâ€™ },
{ id: â€˜CUSTOMâ€™, label: â€˜Personalizadaâ€™, norm: â€˜â€”â€™, alpha: 60, tolExt: â€˜â€”â€™, tolInt: â€˜â€”â€™ },
];

const RAW_THREADS = [
// â”€â”€ MÃ‰TRICA ISO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜Mâ€™, n:â€˜M1â€™,       d:1,    p:0.25, d2:0.8376, d1:0.7294 },
{ s:â€˜Mâ€™, n:â€˜M1.2â€™,     d:1.2,  p:0.25, d2:1.0376, d1:0.9294 },
{ s:â€˜Mâ€™, n:â€˜M1.6â€™,     d:1.6,  p:0.35, d2:1.3726, d1:1.2210 },
{ s:â€˜Mâ€™, n:â€˜M2â€™,       d:2,    p:0.4,  d2:1.7402, d1:1.5670 },
{ s:â€˜Mâ€™, n:â€˜M2.5â€™,     d:2.5,  p:0.45, d2:2.2077, d1:2.0133 },
{ s:â€˜Mâ€™, n:â€˜M3â€™,       d:3,    p:0.5,  d2:2.6752, d1:2.4596 },
{ s:â€˜Mâ€™, n:â€˜M4â€™,       d:4,    p:0.7,  d2:3.5452, d1:3.2423 },
{ s:â€˜Mâ€™, n:â€˜M5â€™,       d:5,    p:0.8,  d2:4.4801, d1:4.1335 },
{ s:â€˜Mâ€™, n:â€˜M6â€™,       d:6,    p:1.0,  d2:5.3500, d1:4.9170 },
{ s:â€˜Mâ€™, n:â€˜M8â€™,       d:8,    p:1.25, d2:7.1880, d1:6.6470 },
{ s:â€˜Mâ€™, n:â€˜M8Ã—1â€™,     d:8,    p:1.0,  d2:7.3500, d1:6.9170, f:1 },
{ s:â€˜Mâ€™, n:â€˜M10â€™,      d:10,   p:1.5,  d2:9.0260, d1:8.3760 },
{ s:â€˜Mâ€™, n:â€˜M10Ã—1.25â€™, d:10,   p:1.25, d2:9.1880, d1:8.6470, f:1 },
{ s:â€˜Mâ€™, n:â€˜M10Ã—1â€™,    d:10,   p:1.0,  d2:9.3500, d1:8.9170, f:1 },
{ s:â€˜Mâ€™, n:â€˜M12â€™,      d:12,   p:1.75, d2:10.863, d1:10.106 },
{ s:â€˜Mâ€™, n:â€˜M12Ã—1.5â€™,  d:12,   p:1.5,  d2:11.026, d1:10.376, f:1 },
{ s:â€˜Mâ€™, n:â€˜M12Ã—1.25â€™, d:12,   p:1.25, d2:11.188, d1:10.647, f:1 },
{ s:â€˜Mâ€™, n:â€˜M14â€™,      d:14,   p:2.0,  d2:12.701, d1:11.835 },
{ s:â€˜Mâ€™, n:â€˜M14Ã—1.5â€™,  d:14,   p:1.5,  d2:13.026, d1:12.376, f:1 },
{ s:â€˜Mâ€™, n:â€˜M16â€™,      d:16,   p:2.0,  d2:14.701, d1:13.835 },
{ s:â€˜Mâ€™, n:â€˜M16Ã—1.5â€™,  d:16,   p:1.5,  d2:15.026, d1:14.376, f:1 },
{ s:â€˜Mâ€™, n:â€˜M18â€™,      d:18,   p:2.5,  d2:16.376, d1:15.294 },
{ s:â€˜Mâ€™, n:â€˜M18Ã—1.5â€™,  d:18,   p:1.5,  d2:17.026, d1:16.376, f:1 },
{ s:â€˜Mâ€™, n:â€˜M20â€™,      d:20,   p:2.5,  d2:18.376, d1:17.294 },
{ s:â€˜Mâ€™, n:â€˜M20Ã—1.5â€™,  d:20,   p:1.5,  d2:19.026, d1:18.376, f:1 },
{ s:â€˜Mâ€™, n:â€˜M22â€™,      d:22,   p:2.5,  d2:20.376, d1:19.294 },
{ s:â€˜Mâ€™, n:â€˜M24â€™,      d:24,   p:3.0,  d2:22.051, d1:20.752 },
{ s:â€˜Mâ€™, n:â€˜M24Ã—2â€™,    d:24,   p:2.0,  d2:22.701, d1:21.835, f:1 },
{ s:â€˜Mâ€™, n:â€˜M27â€™,      d:27,   p:3.0,  d2:25.051, d1:23.752 },
{ s:â€˜Mâ€™, n:â€˜M30â€™,      d:30,   p:3.5,  d2:27.727, d1:26.211 },
{ s:â€˜Mâ€™, n:â€˜M30Ã—2â€™,    d:30,   p:2.0,  d2:28.701, d1:27.835, f:1 },
{ s:â€˜Mâ€™, n:â€˜M33â€™,      d:33,   p:3.5,  d2:30.727, d1:29.211 },
{ s:â€˜Mâ€™, n:â€˜M36â€™,      d:36,   p:4.0,  d2:33.402, d1:31.670 },
{ s:â€˜Mâ€™, n:â€˜M39â€™,      d:39,   p:4.0,  d2:36.402, d1:34.670 },
{ s:â€˜Mâ€™, n:â€˜M42â€™,      d:42,   p:4.5,  d2:39.077, d1:37.129 },
{ s:â€˜Mâ€™, n:â€˜M45â€™,      d:45,   p:4.5,  d2:42.077, d1:40.129 },
{ s:â€˜Mâ€™, n:â€˜M48â€™,      d:48,   p:5.0,  d2:44.752, d1:42.587 },
{ s:â€˜Mâ€™, n:â€˜M52â€™,      d:52,   p:5.0,  d2:48.752, d1:46.587 },
{ s:â€˜Mâ€™, n:â€˜M56â€™,      d:56,   p:5.5,  d2:52.428, d1:50.046 },
{ s:â€˜Mâ€™, n:â€˜M60â€™,      d:60,   p:5.5,  d2:56.428, d1:54.046 },
{ s:â€˜Mâ€™, n:â€˜M64â€™,      d:64,   p:6.0,  d2:60.103, d1:57.505 },
{ s:â€˜Mâ€™, n:â€˜M68â€™,      d:68,   p:6.0,  d2:64.103, d1:61.505 },
{ s:â€˜Mâ€™, n:â€˜M72â€™,      d:72,   p:6.0,  d2:68.103, d1:65.505 },
{ s:â€˜Mâ€™, n:â€˜M80â€™,      d:80,   p:6.0,  d2:76.103, d1:73.505 },
{ s:â€˜Mâ€™, n:â€˜M90â€™,      d:90,   p:6.0,  d2:86.103, d1:83.505 },
{ s:â€˜Mâ€™, n:â€˜M100â€™,     d:100,  p:6.0,  d2:96.103, d1:93.505 },
// â”€â”€ UNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜UNCâ€™, n:â€™#4-40 UNCâ€™,   d:2.845,  p:0.635,  d2:2.433,  d1:2.094 },
{ s:â€˜UNCâ€™, n:â€™#6-32 UNCâ€™,   d:3.505,  p:0.7938, d2:2.990,  d1:2.567 },
{ s:â€˜UNCâ€™, n:â€™#8-32 UNCâ€™,   d:4.166,  p:0.7938, d2:3.650,  d1:3.227 },
{ s:â€˜UNCâ€™, n:â€™#10-24 UNCâ€™,  d:4.826,  p:1.058,  d2:4.138,  d1:3.571 },
{ s:â€˜UNCâ€™, n:â€˜1/4-20 UNCâ€™,  d:6.350,  p:1.270,  d2:5.486,  d1:4.780 },
{ s:â€˜UNCâ€™, n:â€˜5/16-18 UNCâ€™, d:7.938,  p:1.411,  d2:6.931,  d1:6.096 },
{ s:â€˜UNCâ€™, n:â€˜3/8-16 UNCâ€™,  d:9.525,  p:1.5875, d2:8.376,  d1:7.353 },
{ s:â€˜UNCâ€™, n:â€˜7/16-14 UNCâ€™, d:11.113, p:1.814,  d2:9.803,  d1:8.611 },
{ s:â€˜UNCâ€™, n:â€˜1/2-13 UNCâ€™,  d:12.700, p:1.954,  d2:11.228, d1:9.858 },
{ s:â€˜UNCâ€™, n:â€˜9/16-12 UNCâ€™, d:14.288, p:2.117,  d2:12.649, d1:11.090 },
{ s:â€˜UNCâ€™, n:â€˜5/8-11 UNCâ€™,  d:15.875, p:2.309,  d2:14.036, d1:12.256 },
{ s:â€˜UNCâ€™, n:â€˜3/4-10 UNCâ€™,  d:19.050, p:2.540,  d2:16.990, d1:14.891 },
{ s:â€˜UNCâ€™, n:â€˜7/8-9 UNCâ€™,   d:22.225, p:2.822,  d2:19.862, d1:17.474 },
{ s:â€˜UNCâ€™, n:â€˜1â€-8 UNCâ€™,    d:25.400, p:3.175,  d2:22.860, d1:20.043 },
{ s:â€˜UNCâ€™, n:â€˜1 1/4-7 UNCâ€™, d:31.750, p:3.629,  d2:28.854, d1:25.692 },
{ s:â€˜UNCâ€™, n:â€˜1 1/2-6 UNCâ€™, d:38.100, p:4.233,  d2:34.590, d1:30.783 },
// â”€â”€ UNF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜UNFâ€™, n:â€™#6-40 UNFâ€™,   d:3.505,  p:0.635,  d2:3.094,  d1:2.754 },
{ s:â€˜UNFâ€™, n:â€™#8-36 UNFâ€™,   d:4.166,  p:0.7056, d2:3.708,  d1:3.327 },
{ s:â€˜UNFâ€™, n:â€™#10-32 UNFâ€™,  d:4.826,  p:0.7938, d2:4.311,  d1:3.886 },
{ s:â€˜UNFâ€™, n:â€˜1/4-28 UNFâ€™,  d:6.350,  p:0.9071, d2:5.690,  d1:5.158 },
{ s:â€˜UNFâ€™, n:â€˜5/16-24 UNFâ€™, d:7.938,  p:1.058,  d2:7.250,  d1:6.629 },
{ s:â€˜UNFâ€™, n:â€˜3/8-24 UNFâ€™,  d:9.525,  p:1.058,  d2:8.838,  d1:8.217 },
{ s:â€˜UNFâ€™, n:â€˜7/16-20 UNFâ€™, d:11.113, p:1.270,  d2:10.249, d1:9.543 },
{ s:â€˜UNFâ€™, n:â€˜1/2-20 UNFâ€™,  d:12.700, p:1.270,  d2:11.836, d1:11.130 },
{ s:â€˜UNFâ€™, n:â€˜5/8-18 UNFâ€™,  d:15.875, p:1.411,  d2:14.868, d1:14.033 },
{ s:â€˜UNFâ€™, n:â€˜3/4-16 UNFâ€™,  d:19.050, p:1.5875, d2:17.900, d1:16.877 },
{ s:â€˜UNFâ€™, n:â€˜7/8-14 UNFâ€™,  d:22.225, p:1.814,  d2:20.910, d1:19.713 },
{ s:â€˜UNFâ€™, n:â€˜1â€-12 UNFâ€™,   d:25.400, p:2.117,  d2:23.761, d1:22.202 },
// â”€â”€ BSW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜BSWâ€™, n:â€˜1/8â€ BSWâ€™,    d:3.175,  p:0.635,  d2:2.764,  d1:2.424 },
{ s:â€˜BSWâ€™, n:â€˜3/16â€ BSWâ€™,   d:4.763,  p:1.058,  d2:4.075,  d1:3.454 },
{ s:â€˜BSWâ€™, n:â€˜1/4â€ BSWâ€™,    d:6.350,  p:1.270,  d2:5.486,  d1:4.780 },
{ s:â€˜BSWâ€™, n:â€˜5/16â€ BSWâ€™,   d:7.938,  p:1.411,  d2:6.931,  d1:6.096 },
{ s:â€˜BSWâ€™, n:â€˜3/8â€ BSWâ€™,    d:9.525,  p:1.588,  d2:8.376,  d1:7.353 },
{ s:â€˜BSWâ€™, n:â€˜1/2â€ BSWâ€™,    d:12.700, p:2.117,  d2:11.345, d1:10.103 },
{ s:â€˜BSWâ€™, n:â€˜5/8â€ BSWâ€™,    d:15.875, p:2.309,  d2:14.328, d1:12.975 },
{ s:â€˜BSWâ€™, n:â€˜3/4â€ BSWâ€™,    d:19.050, p:2.540,  d2:17.424, d1:15.912 },
{ s:â€˜BSWâ€™, n:â€˜1â€ BSWâ€™,      d:25.400, p:3.175,  d2:23.367, d1:21.464 },
{ s:â€˜BSWâ€™, n:â€˜1 1/4â€ BSWâ€™,  d:31.750, p:3.629,  d2:29.428, d1:27.234 },
{ s:â€˜BSWâ€™, n:â€˜1 1/2â€ BSWâ€™,  d:38.100, p:4.233,  d2:35.592, d1:33.166 },
// â”€â”€ Trapezoidal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜Trâ€™, n:â€˜Tr10Ã—2â€™,   d:10,  p:2,  d2:9.0,   d1:7.5 },
{ s:â€˜Trâ€™, n:â€˜Tr12Ã—3â€™,   d:12,  p:3,  d2:10.5,  d1:8.5 },
{ s:â€˜Trâ€™, n:â€˜Tr16Ã—4â€™,   d:16,  p:4,  d2:14.0,  d1:11.5 },
{ s:â€˜Trâ€™, n:â€˜Tr20Ã—4â€™,   d:20,  p:4,  d2:18.0,  d1:15.5 },
{ s:â€˜Trâ€™, n:â€˜Tr22Ã—5â€™,   d:22,  p:5,  d2:19.5,  d1:16.5 },
{ s:â€˜Trâ€™, n:â€˜Tr24Ã—5â€™,   d:24,  p:5,  d2:21.5,  d1:18.5 },
{ s:â€˜Trâ€™, n:â€˜Tr28Ã—5â€™,   d:28,  p:5,  d2:25.5,  d1:22.5 },
{ s:â€˜Trâ€™, n:â€˜Tr30Ã—6â€™,   d:30,  p:6,  d2:27.0,  d1:23.5 },
{ s:â€˜Trâ€™, n:â€˜Tr36Ã—6â€™,   d:36,  p:6,  d2:33.0,  d1:29.5 },
{ s:â€˜Trâ€™, n:â€˜Tr40Ã—7â€™,   d:40,  p:7,  d2:36.5,  d1:32.5 },
{ s:â€˜Trâ€™, n:â€˜Tr48Ã—8â€™,   d:48,  p:8,  d2:44.0,  d1:39.5 },
{ s:â€˜Trâ€™, n:â€˜Tr60Ã—9â€™,   d:60,  p:9,  d2:55.5,  d1:50.5 },
{ s:â€˜Trâ€™, n:â€˜Tr80Ã—10â€™,  d:80,  p:10, d2:75.0,  d1:69.0 },
// â”€â”€ ACME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜ACMEâ€™, n:â€˜1/2-10 ACMEâ€™,  d:12.700, p:2.540, d2:11.430, d1:10.160 },
{ s:â€˜ACMEâ€™, n:â€˜5/8-8 ACMEâ€™,   d:15.875, p:3.175, d2:14.288, d1:12.700 },
{ s:â€˜ACMEâ€™, n:â€˜3/4-6 ACMEâ€™,   d:19.050, p:4.233, d2:16.933, d1:14.817 },
{ s:â€˜ACMEâ€™, n:â€˜1â€-5 ACMEâ€™,    d:25.400, p:5.080, d2:22.860, d1:20.320 },
{ s:â€˜ACMEâ€™, n:â€˜1 1/4-5 ACMEâ€™, d:31.750, p:5.080, d2:29.210, d1:26.670 },
{ s:â€˜ACMEâ€™, n:â€˜1 1/2-4 ACMEâ€™, d:38.100, p:6.350, d2:34.925, d1:31.750 },
// â”€â”€ BSP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜BSPPâ€™, n:â€˜G 1/8â€ BSPâ€™,  d:9.728,  p:0.907, d2:9.147,  d1:8.566 },
{ s:â€˜BSPPâ€™, n:â€˜G 1/4â€ BSPâ€™,  d:13.157, p:1.337, d2:12.301, d1:11.445 },
{ s:â€˜BSPPâ€™, n:â€˜G 3/8â€ BSPâ€™,  d:16.662, p:1.337, d2:15.806, d1:14.950 },
{ s:â€˜BSPPâ€™, n:â€˜G 1/2â€ BSPâ€™,  d:20.955, p:1.814, d2:19.793, d1:18.631 },
{ s:â€˜BSPPâ€™, n:â€˜G 3/4â€ BSPâ€™,  d:26.441, p:1.814, d2:25.279, d1:24.117 },
{ s:â€˜BSPPâ€™, n:â€˜G 1â€ BSPâ€™,    d:33.249, p:2.309, d2:31.770, d1:30.291 },
{ s:â€˜BSPPâ€™, n:â€˜G 1 1/2â€ BSPâ€™,d:47.803, p:2.309, d2:46.324, d1:44.845 },
{ s:â€˜BSPPâ€™, n:â€˜G 2â€ BSPâ€™,    d:59.614, p:2.309, d2:58.135, d1:56.656 },
// â”€â”€ NPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{ s:â€˜NPTâ€™, n:â€˜1/8â€ NPTâ€™,  d:10.287, p:0.941, d2:9.489,  d1:8.128 },
{ s:â€˜NPTâ€™, n:â€˜1/4â€ NPTâ€™,  d:13.716, p:1.411, d2:12.487, d1:10.879 },
{ s:â€˜NPTâ€™, n:â€˜3/8â€ NPTâ€™,  d:17.145, p:1.411, d2:15.916, d1:14.308 },
{ s:â€˜NPTâ€™, n:â€˜1/2â€ NPTâ€™,  d:21.336, p:1.814, d2:19.772, d1:17.980 },
{ s:â€˜NPTâ€™, n:â€˜3/4â€ NPTâ€™,  d:26.670, p:1.814, d2:25.106, d1:23.314 },
{ s:â€˜NPTâ€™, n:â€˜1â€ NPTâ€™,    d:33.401, p:2.209, d2:31.461, d1:29.187 },
{ s:â€˜NPTâ€™, n:â€˜1 1/2â€ NPTâ€™,d:48.260, p:2.209, d2:46.320, d1:44.046 },
{ s:â€˜NPTâ€™, n:â€˜2â€ NPTâ€™,    d:60.325, p:2.209, d2:58.385, d1:56.111 },
];

const THREADS = RAW_THREADS.map(t => ({
id: `${t.s}_${t.n}`.replace(/[\sâ€/.]/g, â€˜_â€™),
std: t.s, name: t.n, d: t.d, p: t.p, d2: t.d2, d1: t.d1, fine: !!t.f,
alpha: THREAD_STANDARDS.find(s => s.id === t.s)?.alpha || 60,
tolExt: THREAD_STANDARDS.find(s => s.id === t.s)?.tolExt || â€˜â€”â€™,
tolInt: THREAD_STANDARDS.find(s => s.id === t.s)?.tolInt || â€˜â€”â€™,
norm: THREAD_STANDARDS.find(s => s.id === t.s)?.norm || â€˜â€”â€™,
}));

const WIRES = [
{ id:â€˜w01â€™, code:â€˜W-0.144â€™, diam:0.14434, uW:0.0002, pMin:0.20, pMax:0.30 },
{ id:â€˜w02â€™, code:â€˜W-0.202â€™, diam:0.20207, uW:0.0002, pMin:0.30, pMax:0.45 },
{ id:â€˜w03â€™, code:â€˜W-0.260â€™, diam:0.25981, uW:0.0002, pMin:0.40, pMax:0.55 },
{ id:â€˜w04â€™, code:â€˜W-0.289â€™, diam:0.28868, uW:0.0002, pMin:0.45, pMax:0.60 },
{ id:â€˜w05â€™, code:â€˜W-0.360â€™, diam:0.36084, uW:0.0002, pMin:0.55, pMax:0.75 },
{ id:â€˜w06â€™, code:â€˜W-0.433â€™, diam:0.43301, uW:0.0002, pMin:0.70, pMax:0.90 },
{ id:â€˜w07â€™, code:â€˜W-0.577â€™, diam:0.57735, uW:0.0002, pMin:0.90, pMax:1.10 },
{ id:â€˜w08â€™, code:â€˜W-0.722â€™, diam:0.72169, uW:0.0002, pMin:1.10, pMax:1.40 },
{ id:â€˜w09â€™, code:â€˜W-0.866â€™, diam:0.86603, uW:0.00015,pMin:1.30, pMax:1.80 },
{ id:â€˜w10â€™, code:â€˜W-1.010â€™, diam:1.01036, uW:0.0002, pMin:1.60, pMax:2.10 },
{ id:â€˜w11â€™, code:â€˜W-1.155â€™, diam:1.15470, uW:0.0002, pMin:1.80, pMax:2.30 },
{ id:â€˜w12â€™, code:â€˜W-1.299â€™, diam:1.29904, uW:0.0002, pMin:2.10, pMax:2.70 },
{ id:â€˜w13â€™, code:â€˜W-1.443â€™, diam:1.44338, uW:0.0002, pMin:2.30, pMax:3.10 },
{ id:â€˜w14â€™, code:â€˜W-1.732â€™, diam:1.73205, uW:0.0003, pMin:2.90, pMax:3.80 },
{ id:â€˜w15â€™, code:â€˜W-2.021â€™, diam:2.02073, uW:0.0003, pMin:3.30, pMax:4.20 },
{ id:â€˜w16â€™, code:â€˜W-2.309â€™, diam:2.30940, uW:0.0003, pMin:3.80, pMax:4.80 },
{ id:â€˜w17â€™, code:â€˜W-2.887â€™, diam:2.88675, uW:0.0004, pMin:4.80, pMax:6.00 },
{ id:â€˜w18â€™, code:â€˜W-3.464â€™, diam:3.46410, uW:0.0004, pMin:5.80, pMax:7.00 },
];

const MATERIALS = {
â€˜Acero al carbonoâ€™:  { alpha: 11.5, e: 210, nu: 0.30 },
â€˜Acero inoxidableâ€™:  { alpha: 16.0, e: 193, nu: 0.28 },
â€˜Acero herramientaâ€™: { alpha: 10.5, e: 205, nu: 0.29 },
â€˜Titanio Ti-6Al-4Vâ€™: { alpha: 8.6,  e: 114, nu: 0.34 },
â€˜Aluminio 6061â€™:     { alpha: 23.6, e: 69,  nu: 0.33 },
â€˜LatÃ³nâ€™:             { alpha: 20.5, e: 100, nu: 0.34 },
â€˜Hierro fundidoâ€™:    { alpha: 11.7, e: 150, nu: 0.26 },
};

const MACHINE_SEED = [
{ id:â€˜mach01â€™, brand:â€˜Mahrâ€™, model:â€˜Mahr 828 PCâ€™, sn:â€™â€™, uCal:0.0006, resolution:0.0001, force:4, forceUnit:â€˜cNâ€™, cert:â€™â€™, certExpiry:â€™â€™ },
{ id:â€˜mach02â€™, brand:â€˜Mahrâ€™, model:â€˜MaraMeter 844 Nâ€™, sn:â€™â€™, uCal:0.001, resolution:0.0001, force:4, forceUnit:â€˜cNâ€™, cert:â€™â€™, certExpiry:â€™â€™ },
{ id:â€˜mach03â€™, brand:â€˜Tesaâ€™, model:â€˜TESA-IMICROâ€™, sn:â€™â€™, uCal:0.0008, resolution:0.0001, force:3, forceUnit:â€˜Nâ€™, cert:â€™â€™, certExpiry:â€™â€™ },
{ id:â€˜mach04â€™, brand:â€˜Mitutoyoâ€™, model:â€˜526-101â€™, sn:â€™â€™, uCal:0.001, resolution:0.0001, force:5, forceUnit:â€˜Nâ€™, cert:â€™â€™, certExpiry:â€™â€™ },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEOMETRY ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcE(M_raw, geo) {
const { W, alpha, p, T, F, alpha_th, E_mod, nu } = geo;
const aH = (alpha / 2) * Math.PI / 180;
const dT = -M_raw * alpha_th * (T - 20);
const M_th = M_raw + dT;
const E_star = E_mod / (2 * (1 - nu * nu));
const R = (W / 2) / 1000;
const Fuse = Math.max(F || 0.001, 0.0001);
const dH = 2 * Math.pow(3 * Fuse / (4 * E_star), 2 / 3) * Math.pow(1 / R, 1 / 3) * 1000;
const M_c = M_th - dH;
const wt = W * (1 + 1 / Math.sin(aH));
const pt = p / (2 * Math.tan(aH));
return { E: M_c - wt + pt, dT, dH, M_th, M_c };
}

function bestWire(p, alpha) {
return p / (2 * Math.cos((alpha / 2) * Math.PI / 180));
}

function calcGUM(r0, r90, geo, ucal, res, uWire, uForce, uTemp, uAngle, nomD) {
const all = [â€¦r0, â€¦r90];
if (all.length < 2) return null;
const n = all.length;
const mean = all.reduce((a, b) => a + b, 0) / n;
const s = Math.sqrt(all.reduce((a, b) => a + (b - mean) ** 2, 0) / (n - 1));
const uA1 = s / Math.sqrt(n), dA1 = n - 1;
let uA2 = 0, dA2 = Infinity;
if (r0.length > 0 && r90.length > 0) {
const m0 = r0.reduce((a, b) => a + b, 0) / r0.length;
const m90 = r90.reduce((a, b) => a + b, 0) / r90.length;
uA2 = Math.abs(m0 - m90) / Math.sqrt(2); dA2 = 1;
}
const { W, alpha, p, E_mod, nu, alpha_th } = geo;
const aH = (alpha / 2) * Math.PI / 180;
const cW = -(1 + 1 / Math.sin(aH));
const uB1 = ucal / 2, uB2 = res / (2 * Math.sqrt(3));
const uB3 = Math.abs(cW) * uWire;
const Es = E_mod / (2 * (1 - nu ** 2)), Rm = W / 2 / 1000, F = Math.max(geo.F || 0.04, 0.001);
const dHdF = (2 / 3) * Math.pow(3 / (4 * Es), 2 / 3) * Math.pow(F, -1 / 3) * Math.pow(1 / Rm, 1 / 3) * 1000;
const uB4 = uForce * dHdF;
const Lc = (nomD || 14) + 3 * W;
const uB5 = uTemp * Math.abs(Lc * alpha_th);
const uaR = (uAngle * Math.PI / 180) / Math.sqrt(3);
const uB6 = uaR * Math.abs(p / (2 * Math.sin(aH) ** 2) * 0.5);
const comps = [
{ name: â€˜Repetibilidadâ€™, sym: â€˜u_A1â€™, type: â€˜Aâ€™, u: uA1, dof: dA1 },
{ name: â€˜VariaciÃ³n planosâ€™, sym: â€˜u_A2â€™, type: â€˜Aâ€™, u: uA2, dof: dA2 },
{ name: â€˜CalibraciÃ³n bancoâ€™, sym: â€˜u_B1â€™, type: â€˜Bâ€™, u: uB1, dof: Infinity },
{ name: â€˜ResoluciÃ³n encoderâ€™, sym: â€˜u_B2â€™, type: â€˜Bâ€™, u: uB2, dof: Infinity },
{ name: â€˜DiÃ¡metro hilo Wâ€™, sym: â€˜u_B3â€™, type: â€˜Bâ€™, u: uB3, dof: Infinity },
{ name: â€˜Fuerza â†’ Hertzâ€™, sym: â€˜u_B4â€™, type: â€˜Bâ€™, u: uB4, dof: Infinity },
{ name: â€˜Temperaturaâ€™, sym: â€˜u_B5â€™, type: â€˜Bâ€™, u: uB5, dof: Infinity },
{ name: â€˜Ãngulo flancoâ€™, sym: â€˜u_B6â€™, type: â€˜Bâ€™, u: uB6, dof: Infinity },
];
const ucSq = comps.reduce((s, c) => s + c.u ** 2, 0);
const uc = Math.sqrt(ucSq);
comps.forEach(c => c.pct = c.u ** 2 / ucSq * 100);
const denom = comps.filter(c => c.dof < Infinity).reduce((s, c) => s + c.u ** 4 / c.dof, 0);
const nuEff = denom > 0 ? ucSq ** 2 / denom : Infinity;
const kT = [[1,13.97],[2,4.53],[3,3.31],[4,2.87],[5,2.65],[6,2.52],[8,2.37],[10,2.28],[15,2.17],[20,2.09],[30,2.04],[50,2.01],[100,2.00]];
let k = 2.0; for (const [nu2, kv] of kT) if (nuEff >= nu2) k = kv;
return { mean, s, n, comps, uc, nuEff, k, U: k * uc, r0, r90, all };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI PRIMITIVES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const C = {
primary: â€˜bg-blue-600 hover:bg-blue-700 text-white shadow-smâ€™,
ghost:   â€˜bg-white hover:bg-slate-50 text-slate-700 border border-slate-200â€™,
danger:  â€˜bg-red-50 hover:bg-red-100 text-red-600 border border-red-200â€™,
success: â€˜bg-emerald-600 hover:bg-emerald-700 text-white shadow-smâ€™,
teal:    â€˜bg-teal-600 hover:bg-teal-700 text-white shadow-smâ€™,
amber:   â€˜bg-amber-500 hover:bg-amber-600 text-white shadow-smâ€™,
};

const Btn = ({ children, variant=â€˜primaryâ€™, size=â€˜mdâ€™, onClick, disabled, className=â€™â€™, icon }) => {
const s = { sm:â€˜text-xs px-3 py-1.5 gap-1.5â€™, md:â€˜text-sm px-4 py-2 gap-2â€™, lg:â€˜text-sm px-5 py-2.5 gap-2â€™ }[size];
return (
<button onClick={onClick} disabled={disabled}
className={`inline-flex items-center font-semibold rounded-lg transition-all ${C[variant]} ${s} ${disabled ? 'opacity-40 cursor-not-allowed' : 'cursor-pointer'} ${className}`}>
{icon && <span className="flex-shrink-0">{icon}</span>}{children}
</button>
);
};

const Inp = (props) => (
<input {â€¦props} className={`w-full text-sm px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-mono placeholder:font-sans placeholder:text-slate-300 ${props.readOnly ? 'text-slate-400 cursor-default' : ''} ${props.className || ''}`} />
);

const Sel = ({ children, â€¦props }) => (
<select {â€¦props} className={`w-full text-sm px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition-all cursor-pointer ${props.className || ''}`}>
{children}
</select>
);

const Fld = ({ label, unit, children, hint }) => (

  <div className="space-y-1.5">
    <label className="block text-[11px] font-bold text-slate-400 uppercase tracking-wider">
      {label}{unit && <span className="ml-1 font-normal normal-case tracking-normal text-slate-300">[{unit}]</span>}
    </label>
    {children}
    {hint && <p className="text-[11px] text-slate-400">{hint}</p>}
  </div>
);

const Card = ({ children, className = â€˜â€™ }) => (

  <div className={`bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden ${className}`}>{children}</div>
);

const Hdg = ({ icon, title, sub, right, color = â€˜blueâ€™ }) => {
const col = { blue:â€˜bg-blue-600â€™, teal:â€˜bg-teal-600â€™, amber:â€˜bg-amber-500â€™, green:â€˜bg-emerald-600â€™, purple:â€˜bg-purple-600â€™, slate:â€˜bg-slate-600â€™, red:â€˜bg-red-500â€™ }[color];
return (
<div className="flex items-center justify-between px-5 py-4 border-b border-slate-100">
<div className="flex items-center gap-3">
<div className={`w-7 h-7 rounded-lg flex items-center justify-center text-white flex-shrink-0 ${col}`}>
<span className="text-xs">{icon}</span>
</div>
<div>
<div className="font-bold text-slate-800 text-sm leading-tight">{title}</div>
{sub && <div className="text-[11px] text-slate-400 leading-tight mt-0.5">{sub}</div>}
</div>
</div>
{right && <div className="flex items-center gap-2">{right}</div>}
</div>
);
};

const Modal = ({ open, onClose, title, children, wide }) => {
if (!open) return null;
return (
<div className=â€œfixed inset-0 z-50 flex items-center justify-center p-4â€ style={{ background: â€˜rgba(15,23,42,0.5)â€™, backdropFilter: â€˜blur(4px)â€™ }}>
<div className={`bg-white rounded-2xl shadow-2xl w-full max-h-[90vh] overflow-y-auto ${wide ? 'max-w-3xl' : 'max-w-lg'}`}>
<div className="flex items-center justify-between px-6 py-4 border-b border-slate-100 sticky top-0 bg-white z-10">
<h2 className="font-bold text-slate-800 text-base">{title}</h2>
<button onClick={onClose} className="w-7 h-7 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-100 transition-colors text-lg leading-none">Ã—</button>
</div>
<div className="p-6">{children}</div>
</div>
</div>
);
};

const Confirm = ({ open, msg, onOk, onCancel }) => (
<Modal open={open} onClose={onCancel} title="Confirmar">
<p className="text-slate-600 mb-5 text-sm">{msg}</p>
<div className="flex justify-end gap-2">
<Btn variant="ghost" onClick={onCancel}>Cancelar</Btn>
<Btn variant="danger" onClick={onOk}>Eliminar</Btn>
</div>
</Modal>
);

const Badge = ({ children, color = â€˜blueâ€™ }) => {
const c = { blue:â€˜bg-blue-100 text-blue-700â€™, teal:â€˜bg-teal-100 text-teal-700â€™, amber:â€˜bg-amber-100 text-amber-700â€™, green:â€˜bg-emerald-100 text-emerald-700â€™, red:â€˜bg-red-100 text-red-700â€™, purple:â€˜bg-purple-100 text-purple-700â€™, slate:â€˜bg-slate-100 text-slate-600â€™ }[color];
return <span className={`inline-flex text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide ${c}`}>{children}</span>;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Tbl({ cols, rows, onEdit, onDel, onView, empty = â€˜Sin registrosâ€™ }) {
return (
<div className="overflow-x-auto">
<table className="w-full text-sm min-w-full">
<thead>
<tr className="border-b border-slate-100">
{cols.map(c => <th key={c.k} className="text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider px-4 py-3">{c.l}</th>)}
<th className="px-4 py-3 text-right text-[10px] font-bold text-slate-400 uppercase tracking-wider">Acciones</th>
</tr>
</thead>
<tbody>
{rows.length === 0 && (
<tr><td colSpan={cols.length + 1} className=â€œtext-center text-slate-300 py-10 text-smâ€>{empty}</td></tr>
)}
{rows.map((row, i) => (
<tr key={i} className="border-b border-slate-50 hover:bg-slate-50/80 transition-colors">
{cols.map(c => (
<td key={c.k} className={`px-4 py-3 ${c.mono ? 'font-mono text-xs' : ''} ${c.bold ? 'font-semibold text-slate-800' : 'text-slate-500'} ${c.max ? 'max-w-[180px] truncate' : ''}`}>
{row._raw?.[c.k] ?? row[c.k] ?? â€˜â€”â€™}
</td>
))}
<td className="px-4 py-3">
<div className="flex items-center justify-end gap-1">
{onView && <button onClick={() => onView(row)} className=â€œw-7 h-7 rounded-lg flex items-center justify-center text-slate-300 hover:bg-blue-50 hover:text-blue-600 transition-colors text-smâ€>ğŸ‘</button>}
{onEdit && <button onClick={() => onEdit(row)} className=â€œw-7 h-7 rounded-lg flex items-center justify-center text-slate-300 hover:bg-blue-50 hover:text-blue-600 transition-colors text-smâ€>âœï¸</button>}
{onDel && <button onClick={() => onDel(row)} className=â€œw-7 h-7 rounded-lg flex items-center justify-center text-slate-300 hover:bg-red-50 hover:text-red-500 transition-colors text-smâ€>ğŸ—‘</button>}
</div>
</td>
</tr>
))}
</tbody>
</table>
</div>
);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS â†’ EQUIPOS â†’ CALIBRACIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ClientsSection() {
const [clients, setClients] = useState(() => DB.get(â€˜clientsâ€™) || []);
const [view, setView] = useState(â€˜listâ€™); // list | equipment | calibration | newcal | viewcal
const [activeClient, setActiveClient] = useState(null);
const [activeEquip, setActiveEquip] = useState(null);
const [activeCal, setActiveCal] = useState(null);
const [cModal, setCModal] = useState(false);
const [eModal, setEModal] = useState(false);
const [editingC, setEditingC] = useState(null);
const [editingE, setEditingE] = useState(null);
const [delConfirm, setDelConfirm] = useState(null);
const blankC = { id: uid(), code: â€˜â€™, name: â€˜â€™, address: â€˜â€™, contact: â€˜â€™, email: â€˜â€™, phone: â€˜â€™, equipments: [] };
const blankE = { id: uid(), ref: â€˜â€™, desc: â€˜â€™, serial: â€˜â€™, material: â€˜Acero al carbonoâ€™, notes: â€˜â€™ };
const [cForm, setCForm] = useState(blankC);
const [eForm, setEForm] = useState(blankE);

const saveClients = (c) => { DB.set(â€˜clientsâ€™, c); setClients(c); };
const FC = (k, v) => setCForm(f => ({ â€¦f, [k]: v }));
const FE = (k, v) => setEForm(f => ({ â€¦f, [k]: v }));

const submitC = () => {
const upd = editingC ? clients.map(c => c.id === editingC ? { â€¦cForm, equipments: c.equipments } : c) : [â€¦clients, { â€¦cForm, equipments: [] }];
saveClients(upd); setCModal(false);
if (activeClient?.id === editingC) setActiveClient(upd.find(c => c.id === editingC));
};
const submitE = () => {
const cl = clients.find(c => c.id === activeClient.id);
const eqs = editingE ? cl.equipments.map(e => e.id === editingE ? eForm : e) : [â€¦(cl.equipments || []), eForm];
const upd = clients.map(c => c.id === cl.id ? { â€¦cl, equipments: eqs } : c);
saveClients(upd);
setActiveClient({ â€¦cl, equipments: eqs });
setEModal(false);
};
const delClient = (c) => setDelConfirm({ type: â€˜clientâ€™, item: c });
const delEquip = (e) => setDelConfirm({ type: â€˜equipâ€™, item: e });
const confirmDel = () => {
if (delConfirm.type === â€˜clientâ€™) {
saveClients(clients.filter(c => c.id !== delConfirm.item.id));
if (activeClient?.id === delConfirm.item.id) { setView(â€˜listâ€™); setActiveClient(null); }
} else {
const cl = clients.find(c => c.id === activeClient.id);
const eqs = cl.equipments.filter(e => e.id !== delConfirm.item.id);
const upd = clients.map(c => c.id === cl.id ? { â€¦cl, equipments: eqs } : c);
saveClients(upd); setActiveClient({ â€¦cl, equipments: eqs });
}
setDelConfirm(null);
};

const getCals = (equipId) => (DB.get(â€˜calibrationsâ€™) || []).filter(c => c.equipId === equipId);

if (view === â€˜newcalâ€™) {
return <NewCalibration equip={activeEquip} client={activeClient}
onSaved={(cal) => { setActiveCal(cal); setView(â€˜viewcalâ€™); }}
onCancel={() => setView(â€˜calibrationâ€™)} existing={null} />;
}
if (view === â€˜viewcalâ€™ && activeCal) {
return <CalView cal={activeCal} onBack={() => setView(â€˜calibrationâ€™)}
onRecal={() => { setView(â€˜newcalâ€™); }}
onEdit={() => setView(â€˜newcalâ€™)} />;
}
if (view === â€˜calibrationâ€™ && activeEquip) {
const cals = getCals(activeEquip.id);
return (
<div className="space-y-4">
{/* breadcrumb */}
<div className="flex items-center gap-2 text-sm">
<button onClick={() => setView(â€˜listâ€™)} className=â€œtext-blue-600 hover:underline font-mediumâ€>{activeClient.name}</button>
<span className="text-slate-300">/</span>
<button onClick={() => setView(â€˜equipmentâ€™)} className=â€œtext-blue-600 hover:underline font-mediumâ€>{activeEquip.ref}</button>
<span className="text-slate-300">/</span>
<span className="text-slate-600 font-semibold">Calibraciones</span>
</div>
<Card>
<Hdg icon=â€œğŸ“‹â€ title={`Equipo: ${activeEquip.ref}`} sub={`${activeEquip.desc} Â· ${activeEquip.serial || 'sin S/N'} Â· ${activeEquip.material}`} color=â€œtealâ€
right={<Btn onClick={() => setView(â€˜newcalâ€™)} icon=â€œâ•â€ size=â€œsmâ€>Nueva calibraciÃ³n</Btn>} />
{cals.length === 0 ? (
<div className="flex flex-col items-center justify-center py-14 gap-3">
<div className="text-5xl">ğŸ“</div>
<div className="text-slate-400 font-medium">Sin calibraciones para este equipo</div>
<Btn onClick={() => setView(â€˜newcalâ€™)} icon=â€œâ•â€>Primera calibraciÃ³n</Btn>
</div>
) : (
<Tbl cols={[
{ k: â€˜certNumâ€™, l: â€˜Certificadoâ€™, bold: true, mono: true },
{ k: â€˜dateâ€™, l: â€˜Fechaâ€™ },
{ k: â€˜threadNameâ€™, l: â€˜Roscaâ€™ },
{ k: â€˜resultâ€™, l: â€˜E Â± U [mm]â€™, mono: true },
{ k: â€˜techNameâ€™, l: â€˜TÃ©cnicoâ€™ },
{ k: â€˜statusBâ€™, l: â€˜Estadoâ€™ },
]} rows={cals.map(c => ({
â€¦c,
date: fmtDate(c.date),
result: c.gum ? `${c.gum.mean.toFixed(5)} Â± ${fmt(c.gum.U)}` : â€˜â€”â€™,
statusB: <Badge color={c.status === â€˜ISSUEDâ€™ ? â€˜greenâ€™ : â€˜amberâ€™}>{c.status}</Badge>,
_raw: c,
}))}
onView={row => { setActiveCal(row._raw); setView(â€˜viewcalâ€™); }}
onEdit={row => { setActiveCal(row._raw); setView(â€˜newcalâ€™); }}
onDel={row => {
const cals = (DB.get(â€˜calibrationsâ€™) || []).filter(c => c.certNum !== row._raw.certNum);
DB.set(â€˜calibrationsâ€™, cals);
setActiveEquip({ â€¦activeEquip }); // force re-render trick
}}
/>
)}
</Card>
<Confirm open={!!delConfirm} msg=â€Â¿Eliminar este registro?â€ onOk={confirmDel} onCancel={() => setDelConfirm(null)} />
</div>
);
}
if (view === â€˜equipmentâ€™ && activeClient) {
return (
<div className="space-y-4">
<div className="flex items-center gap-2 text-sm">
<button onClick={() => setView(â€˜listâ€™)} className=â€œtext-blue-600 hover:underline font-mediumâ€>{activeClient.name}</button>
<span className="text-slate-300">/</span>
<span className="text-slate-600 font-semibold">Equipos</span>
</div>
<Card>
<Hdg icon=â€œğŸ­â€ title={activeClient.name} sub={`${activeClient.code} Â· ${activeClient.address || 'Sin direcciÃ³n'}`} color=â€œblueâ€
right={
<div className="flex gap-2">
<Btn size=â€œsmâ€ variant=â€œghostâ€ onClick={() => { setEditingC(activeClient.id); setCForm({ â€¦activeClient }); setCModal(true); }} icon=â€œâœï¸â€>Editar cliente</Btn>
<Btn size=â€œsmâ€ onClick={() => { setEditingE(null); setEForm({ â€¦blankE, id: uid() }); setEModal(true); }} icon=â€œâ•â€>AÃ±adir equipo</Btn>
</div>
} />
{(activeClient.equipments || []).length === 0 ? (
<div className="flex flex-col items-center py-12 gap-3">
<div className="text-4xl">ğŸ”©</div>
<div className="text-slate-400">Sin equipos registrados</div>
<Btn onClick={() => { setEditingE(null); setEForm({ â€¦blankE, id: uid() }); setEModal(true); }} icon=â€œâ•â€>AÃ±adir primer equipo</Btn>
</div>
) : (
<Tbl cols={[
{ k: â€˜refâ€™, l: â€˜Referenciaâ€™, bold: true },
{ k: â€˜descâ€™, l: â€˜DescripciÃ³nâ€™, max: true },
{ k: â€˜serialâ€™, l: â€˜NÂº Serieâ€™ },
{ k: â€˜materialâ€™, l: â€˜Materialâ€™ },
{ k: â€˜ncalsâ€™, l: â€˜Calibracionesâ€™, mono: true },
]} rows={(activeClient.equipments || []).map(e => ({
â€¦e,
ncals: getCals(e.id).length || â€˜0â€™,
_raw: e,
}))}
onView={row => { setActiveEquip(row._raw); setView(â€˜calibrationâ€™); }}
onEdit={row => { setEditingE(row._raw.id); setEForm({ â€¦row._raw }); setEModal(true); }}
onDel={row => delEquip(row._raw)}
/>
)}
</Card>
{/* Equipment modal */}
<Modal open={eModal} onClose={() => setEModal(false)} title={editingE ? â€˜Editar equipoâ€™ : â€˜Nuevo equipoâ€™}>
<div className="grid grid-cols-2 gap-4">
<Fld label="Referencia" required><Inp value={eForm.ref} onChange={e => FE(â€˜refâ€™, e.target.value)} placeholder=â€œEQ-001â€ /></Fld>
<Fld label="NÂº de serie"><Inp value={eForm.serial} onChange={e => FE(â€˜serialâ€™, e.target.value)} /></Fld>
<div className="col-span-2"><Fld label="DescripciÃ³n"><Inp value={eForm.desc} onChange={e => FE(â€˜descâ€™, e.target.value)} placeholder=â€œTornillo M14Ã—1.5 lote 2025-Aâ€ /></Fld></div>
<div className="col-span-2"><Fld label="Material">
<Sel value={eForm.material} onChange={e => FE(â€˜materialâ€™, e.target.value)}>
{Object.keys(MATERIALS).map(m => <option key={m}>{m}</option>)}
</Sel>
</Fld></div>
<div className="col-span-2"><Fld label="Notas"><textarea className=â€œw-full text-sm px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-400 outline-none resize-none h-16â€ value={eForm.notes} onChange={e => FE(â€˜notesâ€™, e.target.value)} /></Fld></div>
</div>
<div className="flex justify-end gap-2 mt-5 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={() => setEModal(false)}>Cancelar</Btn>
<Btn onClick={submitE} icon="ğŸ’¾">{editingE ? â€˜Guardar cambiosâ€™ : â€˜Crear equipoâ€™}</Btn>
</div>
</Modal>
<Confirm open={!!delConfirm} msg={`Â¿Eliminar "${delConfirm?.item?.ref || delConfirm?.item?.name}"?`} onOk={confirmDel} onCancel={() => setDelConfirm(null)} />
</div>
);
}

// â”€â”€ CLIENT LIST â”€â”€
return (
<div className="space-y-4">
<div className="flex items-center justify-between">
<div>
<h2 className="font-bold text-slate-800 text-lg">Clientes</h2>
<p className="text-xs text-slate-400 mt-0.5">Selecciona un cliente para ver sus equipos y calibraciones</p>
</div>
<Btn onClick={() => { setEditingC(null); setCForm({ â€¦blankC, id: uid() }); setCModal(true); }} icon=â€œâ•â€>Nuevo cliente</Btn>
</div>
<div className="grid grid-cols-1 gap-3">
{clients.length === 0 && (
<Card className="flex flex-col items-center py-16 gap-3">
<div className="text-5xl">ğŸ­</div>
<div className="text-slate-400 font-medium">Sin clientes â€” aÃ±ade el primero</div>
<Btn onClick={() => { setEditingC(null); setCForm({ â€¦blankC, id: uid() }); setCModal(true); }} icon=â€œâ•â€>AÃ±adir cliente</Btn>
</Card>
)}
{clients.map(cl => {
const totalCals = (cl.equipments || []).reduce((a, e) => a + getCals(e.id).length, 0);
return (
<Card key={cl.id}>
<div className="flex items-center p-5 gap-4">
<div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white font-bold text-lg flex-shrink-0 shadow-sm shadow-blue-200">
{cl.name.charAt(0).toUpperCase()}
</div>
<div className="flex-1 min-w-0">
<div className="flex items-center gap-2">
<span className="font-bold text-slate-800">{cl.name}</span>
{cl.code && <Badge color="slate">{cl.code}</Badge>}
</div>
<div className="text-xs text-slate-400 mt-0.5 truncate">{cl.address || cl.email || cl.contact || â€˜Sin datos de contactoâ€™}</div>
<div className="flex items-center gap-3 mt-2">
<span className="text-xs text-slate-400">ğŸ”© {(cl.equipments || []).length} equipos</span>
<span className="text-xs text-slate-400">ğŸ“‹ {totalCals} calibraciones</span>
</div>
</div>
<div className="flex items-center gap-2">
<Btn size=â€œsmâ€ variant=â€œghostâ€ onClick={() => { setEditingC(cl.id); setCForm({ â€¦cl }); setCModal(true); }} icon=â€œâœï¸â€>Editar</Btn>
<Btn size=â€œsmâ€ variant=â€œdangerâ€ onClick={() => delClient(cl)} icon=â€œğŸ—‘â€>Eliminar</Btn>
<Btn size=â€œsmâ€ onClick={() => { setActiveClient(cl); setView(â€˜equipmentâ€™); }} icon=â€œâ†’â€>Ver equipos</Btn>
</div>
</div>
</Card>
);
})}
</div>
{/* Client modal */}
<Modal open={cModal} onClose={() => setCModal(false)} title={editingC ? â€˜Editar clienteâ€™ : â€˜Nuevo clienteâ€™}>
<div className="grid grid-cols-2 gap-4">
<Fld label="CÃ³digo"><Inp value={cForm.code} onChange={e => FC(â€˜codeâ€™, e.target.value)} placeholder=â€œCLI-001â€ /></Fld>
<Fld label="Nombre" required><Inp value={cForm.name} onChange={e => FC(â€˜nameâ€™, e.target.value)} /></Fld>
<div className="col-span-2"><Fld label="DirecciÃ³n"><Inp value={cForm.address} onChange={e => FC(â€˜addressâ€™, e.target.value)} /></Fld></div>
<Fld label="Contacto"><Inp value={cForm.contact} onChange={e => FC(â€˜contactâ€™, e.target.value)} /></Fld>
<Fld label="Email"><Inp type=â€œemailâ€ value={cForm.email} onChange={e => FC(â€˜emailâ€™, e.target.value)} /></Fld>
<div className="col-span-2"><Fld label="TelÃ©fono"><Inp value={cForm.phone} onChange={e => FC(â€˜phoneâ€™, e.target.value)} /></Fld></div>
</div>
<div className="flex justify-end gap-2 mt-5 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={() => setCModal(false)}>Cancelar</Btn>
<Btn onClick={submitC} icon="ğŸ’¾">{editingC ? â€˜Guardarâ€™ : â€˜Crear clienteâ€™}</Btn>
</div>
</Modal>
<Confirm open={!!delConfirm} msg={`Â¿Eliminar cliente "${delConfirm?.item?.name}"? Se perderÃ¡n todos sus equipos.`} onOk={confirmDel} onCancel={() => setDelConfirm(null)} />
</div>
);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW CALIBRATION WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function NewCalibration({ equip, client, onSaved, onCancel, existing }) {
const cfg = DB.get(â€˜configâ€™) || {};
const machines = DB.get(â€˜machinesâ€™) || MACHINE_SEED;
const techs = DB.get(â€˜techsâ€™) || [];

const init = existing || {
certNum: `CAL-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9000) + 1000)}`,
date: today(), machineId: â€˜â€™, techId: â€˜â€™,
threadId: â€˜â€™, threadName: â€˜â€™, tolClass: â€˜â€™, direction: â€˜externalâ€™,
tolMin: â€˜â€™, tolMax: â€˜â€™,
wireId: â€˜â€™, wireDiam: â€˜â€™, uWire: 0.00015, wireCert: â€˜â€™,
temp: 20.0, humidity: 48, uTemp: 0.1, uForce: 0.002, uAngle: 0.1,
alpha_th: 11.5, e_mod: 210, nu: 0.30,
readings0: [â€™â€™, â€˜â€™, â€˜â€™], readings90: [â€™â€™, â€˜â€™, â€˜â€™],
signature: â€˜â€™, status: â€˜DRAFTâ€™, gum: null,
equipId: equip?.id, clientId: client?.id,
clientName: client?.name, equipRef: equip?.ref,
labName: cfg.labName || â€˜Laboratorio de MetrologÃ­aâ€™,
};
const [s, setS] = useState(init);
const [step, setStep] = useState(0);
const sv = (k, v) => setS(p => ({ â€¦p, [k]: v }));

const machine = machines.find(m => m.id === s.machineId);
const tech = techs.find(t => t.id === s.techId);
const thread = THREADS.find(t => t.id === s.threadId);
const wire = WIRES.find(w => w.id === s.wireId);

useEffect(() => {
if (thread) {
sv(â€˜threadNameâ€™, thread.name);
sv(â€˜tolClassâ€™, s.direction === â€˜externalâ€™ ? thread.tolExt : thread.tolInt);
// auto best-wire suggestion
}
}, [s.threadId, s.direction]);

useEffect(() => {
if (wire) { sv(â€˜wireDiamâ€™, wire.diam); sv(â€˜uWireâ€™, wire.uW); }
}, [s.wireId]);

useEffect(() => {
const mat = MATERIALS[equip?.material];
if (mat) { sv(â€˜alpha_thâ€™, mat.alpha); sv(â€˜e_modâ€™, mat.e); sv(â€˜nuâ€™, mat.nu); }
}, []);

const geo = {
W: +s.wireDiam || 0.866, alpha: thread?.alpha || 60, p: thread?.p || 1.5,
T: +s.temp, F: machine ? (machine.forceUnit === â€˜cNâ€™ ? machine.force / 100 : +machine.force) : 0.04,
alpha_th: +s.alpha_th * 1e-6, E_mod: +s.e_mod * 1e9, nu: +s.nu,
};

const bw = thread ? bestWire(thread.p, thread.alpha) : 0;
const getE = (v) => { const r = +v; if (!v || isNaN(r)) return null; return calcE(r, geo); };
const r0vals = s.readings0.map(v => getE(v)?.E).filter(v => v != null);
const r90vals = s.readings90.map(v => getE(v)?.E).filter(v => v != null);

const runGUM = () => {
const ucal = machine ? +machine.uCal : 0.0006;
const res = machine ? +machine.resolution : 0.0001;
const g = calcGUM(r0vals, r90vals, geo, ucal, res, +s.uWire, +s.uForce, +s.uTemp, +s.uAngle, thread?.d);
if (g) sv(â€˜gumâ€™, g);
return g;
};

const doSave = (gum) => {
const cal = {
â€¦s, gum: gum || s.gum, status: â€˜ISSUEDâ€™,
threadName: thread?.name || s.threadName,
techName: tech?.name || tech?.code || â€˜â€”â€™,
savedAt: new Date().toISOString(),
};
const cals = DB.get(â€˜calibrationsâ€™) || [];
const idx = cals.findIndex(c => c.certNum === cal.certNum);
if (idx >= 0) cals[idx] = cal; else cals.unshift(cal);
DB.set(â€˜calibrationsâ€™, cals);
onSaved(cal);
};

const canvasRef = useRef(null);
const [drawing, setDrawing] = useState(false);
const startDraw = (e) => {
setDrawing(true);
const c = canvasRef.current, r = c.getBoundingClientRect(), ctx = c.getContext(â€˜2dâ€™);
ctx.beginPath(); ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
};
const draw = (e) => {
if (!drawing) return;
const c = canvasRef.current, r = c.getBoundingClientRect(), ctx = c.getContext(â€˜2dâ€™);
ctx.lineWidth = 2; ctx.lineCap = â€˜roundâ€™; ctx.strokeStyle = â€˜#1e293bâ€™;
ctx.lineTo(e.clientX - r.left, e.clientY - r.top); ctx.stroke();
};
const endDraw = () => { setDrawing(false); sv(â€˜signatureâ€™, canvasRef.current?.toDataURL()); };

const STEPS = [â€˜Proyectoâ€™, â€˜Roscaâ€™, â€˜Hilo & Cond.â€™, â€˜Medicionesâ€™, â€˜Resultadoâ€™, â€˜Certificadoâ€™];

return (
<div className="space-y-4 max-w-4xl mx-auto">
{/* Header */}
<div className="flex items-center gap-3">
<button onClick={onCancel} className="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition-colors">â†</button>
<div>
<h2 className="font-bold text-slate-800">{existing ? â€˜Editar / Recalibrarâ€™ : â€˜Nueva calibraciÃ³nâ€™}</h2>
<p className="text-xs text-slate-400 font-mono">{client?.name} â†’ {equip?.ref} Â· {s.certNum}</p>
</div>
</div>
{/* Step pills */}
<div className="flex gap-1.5 overflow-x-auto pb-1">
{STEPS.map((name, i) => (
<button key={i} onClick={() => setStep(i)}
className={`flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold transition-all ${step === i ? 'bg-blue-600 text-white' : i < step ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
{i < step ? â€˜âœ“â€™ : <span className="w-3.5 h-3.5 rounded-full bg-current/20 flex items-center justify-center text-[9px]">{i + 1}</span>}
{name}
</button>
))}
</div>

```
  {/* â”€â”€ STEP 0: PROYECTO â”€â”€ */}
  {step === 0 && (
    <div className="grid grid-cols-2 gap-4">
      <Card>
        <Hdg icon="ğŸ“‹" title="Datos del encargo" color="blue" />
        <div className="p-5 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <Fld label="NÂº Certificado"><Inp value={s.certNum} onChange={e => sv('certNum', e.target.value)} /></Fld>
            <Fld label="Fecha"><Inp type="date" value={s.date} onChange={e => sv('date', e.target.value)} /></Fld>
          </div>
          <Fld label="Laboratorio"><Inp value={s.labName} onChange={e => sv('labName', e.target.value)} /></Fld>
          <Fld label="TÃ©cnico responsable">
            <Sel value={s.techId} onChange={e => sv('techId', e.target.value)}>
              <option value="">â€” Seleccionar tÃ©cnico â€”</option>
              {techs.map(t => <option key={t.id} value={t.id}>{t.code} â€” {t.name}</option>)}
            </Sel>
          </Fld>
          <Fld label="Banco de mediciÃ³n">
            <Sel value={s.machineId} onChange={e => sv('machineId', e.target.value)}>
              <option value="">â€” Seleccionar banco â€”</option>
              {machines.map(m => <option key={m.id} value={m.id}>{m.brand} {m.model}{m.sn ? ` Â· SN: ${m.sn}` : ''}</option>)}
            </Sel>
          </Fld>
          {machine && (
            <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 text-xs space-y-1">
              <div className="flex justify-between"><span className="text-blue-500">U cal (k=2):</span><span className="font-mono font-bold">{machine.uCal} mm</span></div>
              <div className="flex justify-between"><span className="text-blue-500">Fuerza:</span><span className="font-mono font-bold">{machine.force} {machine.forceUnit}</span></div>
              {machine.certExpiry && <div className="flex justify-between"><span className="text-blue-500">Cal. vÃ¡lida:</span><span className="font-mono">{machine.certExpiry}</span></div>}
            </div>
          )}
        </div>
      </Card>
      <Card>
        <Hdg icon="ğŸ­" title="Equipo a calibrar" color="teal" />
        <div className="p-5 space-y-3">
          <div className="bg-teal-50 border border-teal-100 rounded-xl p-4 space-y-2">
            <div className="flex items-center gap-2">
              <span className="text-2xl">ğŸ”©</span>
              <div>
                <div className="font-bold text-slate-800">{equip?.ref}</div>
                <div className="text-xs text-slate-500">{equip?.desc}</div>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
              <div><span className="text-slate-400">Cliente:</span> <span className="font-semibold">{client?.name}</span></div>
              <div><span className="text-slate-400">S/N:</span> <span className="font-mono">{equip?.serial || 'â€”'}</span></div>
              <div><span className="text-slate-400">Material:</span> <span className="font-semibold">{equip?.material}</span></div>
            </div>
          </div>
          <Fld label="DirecciÃ³n de rosca">
            <Sel value={s.direction} onChange={e => sv('direction', e.target.value)}>
              <option value="external">Tornillo (externo)</option>
              <option value="internal">Tuerca (interno)</option>
            </Sel>
          </Fld>
        </div>
      </Card>
      <div className="col-span-2 flex justify-end">
        <Btn onClick={() => setStep(1)}>Siguiente: Rosca â†’</Btn>
      </div>
    </div>
  )}

  {/* â”€â”€ STEP 1: ROSCA â”€â”€ */}
  {step === 1 && (
    <div className="space-y-4">
      <Card>
        <Hdg icon="âš™ï¸" title="SelecciÃ³n de rosca" sub="Todas las normas ISO/ASME cargadas" color="blue" />
        <div className="p-5 space-y-4">
          <div className="grid grid-cols-3 gap-3">
            <div className="col-span-1">
              <Fld label="Norma">
                <Sel value={s.threadStd || ''} onChange={e => { sv('threadStd', e.target.value); sv('threadId', ''); }}>
                  <option value="">Todas</option>
                  {THREAD_STANDARDS.filter(s => s.id !== 'CUSTOM').map(std =>
                    <option key={std.id} value={std.id}>{std.label}</option>
                  )}
                </Sel>
              </Fld>
            </div>
            <div className="col-span-2">
              <Fld label="Rosca">
                <Sel value={s.threadId} onChange={e => sv('threadId', e.target.value)}>
                  <option value="">â€” Seleccionar rosca â€”</option>
                  {THREADS
                    .filter(t => !s.threadStd || t.std === s.threadStd)
                    .map(t => <option key={t.id} value={t.id}>{t.name} â€” âˆ…{t.d}Ã—{t.p} mm</option>)}
                </Sel>
              </Fld>
            </div>
          </div>
          {thread && (
            <div className="grid grid-cols-4 gap-3">
              {[
                { l: 'D nominal', v: `${thread.d} mm` },
                { l: 'Paso p', v: `${thread.p} mm` },
                { l: 'D de paso d2', v: `${thread.d2} mm` },
                { l: 'D menor d1', v: `${thread.d1} mm` },
                { l: 'Ãngulo Î±', v: `${thread.alpha}Â°` },
                { l: 'Norma', v: thread.norm },
                { l: 'Tol. ext.', v: thread.tolExt },
                { l: 'Tol. int.', v: thread.tolInt },
              ].map(item => (
                <div key={item.l} className="bg-slate-50 rounded-lg p-3 border border-slate-100">
                  <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wide mb-1">{item.l}</div>
                  <div className="font-mono font-bold text-slate-800 text-sm">{item.v}</div>
                </div>
              ))}
            </div>
          )}
          <div className="grid grid-cols-3 gap-3">
            <Fld label="Clase tolerancia">
              <Inp value={s.tolClass} onChange={e => sv('tolClass', e.target.value)} placeholder={thread ? (s.direction === 'external' ? thread.tolExt : thread.tolInt) : '6g'} />
            </Fld>
            <Fld label="Tol. mÃ­n." unit="mm"><Inp type="number" value={s.tolMin} onChange={e => sv('tolMin', e.target.value)} step="0.0001" placeholder="Opcional" /></Fld>
            <Fld label="Tol. mÃ¡x." unit="mm"><Inp type="number" value={s.tolMax} onChange={e => sv('tolMax', e.target.value)} step="0.0001" placeholder="Opcional" /></Fld>
          </div>
        </div>
      </Card>
      <div className="flex justify-between">
        <Btn variant="ghost" onClick={() => setStep(0)}>â† Volver</Btn>
        <Btn onClick={() => setStep(2)} disabled={!s.threadId}>Siguiente: Hilo & Condiciones â†’</Btn>
      </div>
    </div>
  )}

  {/* â”€â”€ STEP 2: HILO & CONDICIONES â”€â”€ */}
  {step === 2 && (
    <div className="grid grid-cols-2 gap-4">
      <Card>
        <Hdg icon="ğŸ“" title="Hilo de mediciÃ³n" color="teal" />
        <div className="p-5 space-y-3">
          {thread && bw > 0 && (
            <div className="bg-emerald-50 border border-emerald-100 rounded-lg p-3 text-sm">
              <div className="text-emerald-700 font-bold">Hilo Ã³ptimo: <span className="font-mono">{bw.toFixed(5)} mm</span></div>
              <div className="text-emerald-600 text-xs mt-0.5">Rango vÃ¡lido: [{(0.56 * thread.p).toFixed(4)}, {(0.90 * thread.p).toFixed(4)}] mm</div>
            </div>
          )}
          <Fld label="Hilo de la base de datos">
            <Sel value={s.wireId} onChange={e => sv('wireId', e.target.value)}>
              <option value="">â€” Seleccionar hilo â€”</option>
              {WIRES
                .filter(w => !thread || (w.pMin <= thread.p && w.pMax >= thread.p))
                .map(w => <option key={w.id} value={w.id}>{w.code} â€” W={w.diam} mm</option>)}
              <optgroup label="Todos los hilos">
                {WIRES
                  .filter(w => !thread || !(w.pMin <= thread.p && w.pMax >= thread.p))
                  .map(w => <option key={w.id} value={w.id}>{w.code} â€” W={w.diam} mm</option>)}
              </optgroup>
            </Sel>
          </Fld>
          <div className="grid grid-cols-2 gap-3">
            <Fld label="W calibrado" unit="mm"><Inp type="number" value={s.wireDiam} onChange={e => sv('wireDiam', e.target.value)} step="0.00001" placeholder="0.86603" /></Fld>
            <Fld label="u(W) k=1" unit="mm"><Inp type="number" value={s.uWire} onChange={e => sv('uWire', e.target.value)} step="0.00001" min="0" /></Fld>
          </div>
          <Fld label="Certificado hilo"><Inp value={s.wireCert} onChange={e => sv('wireCert', e.target.value)} placeholder="ENAC-C-XXXX" /></Fld>
        </div>
      </Card>
      <Card>
        <Hdg icon="ğŸŒ¡ï¸" title="Condiciones ambientales y material" color="amber" />
        <div className="p-5 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <Fld label="Temperatura" unit="Â°C">
              <Inp type="number" value={s.temp} onChange={e => sv('temp', e.target.value)} step="0.1" />
            </Fld>
            <Fld label="Humedad" unit="%"><Inp type="number" value={s.humidity} onChange={e => sv('humidity', e.target.value)} step="1" /></Fld>
          </div>
          <div className="grid grid-cols-3 gap-2">
            <Fld label="u(T)" unit="Â°C"><Inp type="number" value={s.uTemp} onChange={e => sv('uTemp', e.target.value)} step="0.01" min="0" /></Fld>
            <Fld label="u(F)" unit="N"><Inp type="number" value={s.uForce} onChange={e => sv('uForce', e.target.value)} step="0.001" min="0" /></Fld>
            <Fld label="u(Î±)" unit="Â°"><Inp type="number" value={s.uAngle} onChange={e => sv('uAngle', e.target.value)} step="0.01" min="0" /></Fld>
          </div>
          <Fld label="Material">
            <Sel value={Object.keys(MATERIALS).find(k => MATERIALS[k].alpha === +s.alpha_th) || ''} onChange={e => { const m = MATERIALS[e.target.value]; if (m) { sv('alpha_th', m.alpha); sv('e_mod', m.e); sv('nu', m.nu); } }}>
              {Object.keys(MATERIALS).map(k => <option key={k} value={k}>{k}</option>)}
            </Sel>
          </Fld>
          <div className="grid grid-cols-3 gap-2">
            <Fld label="Î±_th" unit="Ã—10â»â¶/K"><Inp type="number" value={s.alpha_th} onChange={e => sv('alpha_th', e.target.value)} step="0.1" /></Fld>
            <Fld label="E" unit="GPa"><Inp type="number" value={s.e_mod} onChange={e => sv('e_mod', e.target.value)} step="1" /></Fld>
            <Fld label="Î½"><Inp type="number" value={s.nu} onChange={e => sv('nu', e.target.value)} step="0.01" /></Fld>
          </div>
          {+s.temp !== 20 && (
            <div className="bg-amber-50 border border-amber-100 rounded-lg p-2 text-xs text-amber-700">
              âš ï¸ Î”T = {(+s.temp - 20).toFixed(1)} Â°C respecto a 20 Â°C (ISO 1:2016). Se aplicarÃ¡ correcciÃ³n tÃ©rmica.
            </div>
          )}
        </div>
      </Card>
      <div className="col-span-2 flex justify-between">
        <Btn variant="ghost" onClick={() => setStep(1)}>â† Volver</Btn>
        <Btn onClick={() => setStep(3)}>Siguiente: Mediciones â†’</Btn>
      </div>
    </div>
  )}

  {/* â”€â”€ STEP 3: MEDICIONES â”€â”€ */}
  {step === 3 && (
    <div className="space-y-4">
      {/* correction strip */}
      {thread && s.wireDiam && (
        <div className="grid grid-cols-4 gap-3">
          {(() => {
            const testM = thread.d + 3 * (+s.wireDiam);
            const r = calcE(testM, geo);
            return [
              { l: 'Î”M tÃ©rmica', v: fmt(r.dT, 6), u: 'mm', info: `T=${s.temp}Â°C` },
              { l: 'Î´ Hertz', v: fmt(r.dH, 6), u: 'mm', info: 'CorrecciÃ³n elÃ¡stica' },
              { l: 'âˆ’W(1+1/sinÎ±/2)', v: fmt(-r.wt, 6), u: 'mm', info: 'TÃ©rmino hilo' },
              { l: 'p/(2Â·tanÎ±/2)', v: fmt(r.pt, 6), u: 'mm', info: 'TÃ©rmino paso' },
            ].map(item => (
              <div key={item.l} className="bg-white rounded-xl border border-slate-200 shadow-sm p-3">
                <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{item.l}</div>
                <div className="font-mono font-bold text-slate-800 mt-1">{item.v} <span className="text-slate-400 text-xs font-normal">{item.u}</span></div>
                <div className="text-[10px] text-slate-400 mt-0.5">{item.info}</div>
              </div>
            ));
          })()}
        </div>
      )}
      <div className="grid grid-cols-2 gap-4">
        {[0, 90].map(plane => {
          const key = `readings${plane}`;
          const vals = plane === 0 ? r0vals : r90vals;
          const mean = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
          const std = vals.length > 1 ? Math.sqrt(vals.reduce((a,b)=>a+(b-mean)**2,0)/(vals.length-1)) : null;
          return (
            <Card key={plane}>
              <Hdg icon={plane === 0 ? 'ğŸ“' : 'ğŸ”„'} title={`Lecturas â€” Plano ${plane}Â°`} color={plane === 0 ? 'blue' : 'teal'}
                right={<button onClick={() => sv(key, [...s[key], ''])} className="text-xs font-semibold text-blue-600 hover:text-blue-700 flex items-center gap-1">â• AÃ±adir</button>} />
              <div className="p-4 space-y-2">
                <div className="grid grid-cols-4 gap-1.5 text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">
                  <span>#</span><span>M_raw [mm]</span><span>M_corr [mm]</span><span>E [mm]</span>
                </div>
                {s[key].map((v, i) => {
                  const res = getE(v);
                  return (
                    <div key={i} className="grid grid-cols-4 gap-1.5 items-center">
                      <span className="text-xs font-bold text-slate-300 text-right">{i + 1}</span>
                      <Inp type="number" step="0.00001" placeholder="M_rawâ€¦" value={v}
                        onChange={e => { const a = [...s[key]]; a[i] = e.target.value; sv(key, a); }} />
                      <div className={`font-mono text-[11px] px-2 py-1.5 rounded-lg text-right border ${res ? 'bg-teal-50 border-teal-100 text-teal-700' : 'bg-slate-50 border-slate-100 text-slate-300'}`}>{res ? res.M_c.toFixed(5) : 'â€”'}</div>
                      <div className="flex gap-1">
                        <div className={`flex-1 font-mono text-[11px] px-2 py-1.5 rounded-lg text-right border font-semibold ${res ? 'bg-blue-50 border-blue-100 text-blue-700' : 'bg-slate-50 border-slate-100 text-slate-300'}`}>{res ? res.E.toFixed(5) : 'â€”'}</div>
                        <button onClick={() => { const a = [...s[key]]; a.splice(i, 1); sv(key, a); }} className="w-5 h-5 flex items-center justify-center text-slate-300 hover:text-red-400 transition-colors text-xs">Ã—</button>
                      </div>
                    </div>
                  );
                })}
                {vals.length >= 2 && (
                  <div className="grid grid-cols-3 gap-2 mt-3 bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div><div className="text-[10px] text-slate-400 font-bold uppercase">Media Ä’</div><div className="font-mono text-sm font-bold">{mean.toFixed(5)}</div></div>
                    <div><div className="text-[10px] text-slate-400 font-bold uppercase">Desv. Est. s</div><div className="font-mono text-sm font-bold">{std.toExponential(2)}</div></div>
                    <div><div className="text-[10px] text-slate-400 font-bold uppercase">n</div><div className="font-mono text-sm font-bold">{vals.length}</div></div>
                  </div>
                )}
              </div>
            </Card>
          );
        })}
      </div>
      <div className="flex justify-between">
        <Btn variant="ghost" onClick={() => setStep(2)}>â† Volver</Btn>
        <Btn onClick={() => { const g = runGUM(); if (!g) { alert('MÃ­nimo 2 lecturas vÃ¡lidas'); return; } setStep(4); }} icon="ğŸ§®">Calcular GUM â†’</Btn>
      </div>
    </div>
  )}

  {/* â”€â”€ STEP 4: RESULTADO GUM â”€â”€ */}
  {step === 4 && s.gum && (() => {
    const g = s.gum;
    let conforms = null;
    if (s.tolMin !== '' && s.tolMax !== '') {
      const lo = g.mean - g.U, hi = g.mean + g.U;
      const full = lo >= +s.tolMin && hi <= +s.tolMax;
      const inT = g.mean >= +s.tolMin && g.mean <= +s.tolMax;
      conforms = full ? 'ok' : inT ? 'warn' : 'err';
    }
    return (
      <div className="space-y-4">
        <div className="bg-gradient-to-br from-blue-50 to-sky-50 border border-blue-100 rounded-2xl p-6 text-center">
          <div className="text-xs text-slate-400 font-mono mb-2">E = M âˆ’ WÂ·(1+1/sinÎ±/2) + p/(2Â·tanÎ±/2) Â· EURAMET cg-10</div>
          <div className="text-3xl font-bold font-mono text-blue-700">
            {g.mean.toFixed(5)} <span className="text-amber-500">Â±</span> <span className="text-amber-600">{fmt(g.U)}</span>
            <span className="text-slate-400 text-lg font-normal ml-2">mm</span>
          </div>
          <div className="text-xs text-slate-400 mt-2">k = {g.k.toFixed(3)} Â· p â‰ˆ 95.45% Â· Î½eff = {g.nuEff < 1e9 ? g.nuEff.toFixed(1) : 'âˆ'}</div>
          {conforms && (
            <div className={`mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold border ${conforms === 'ok' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : conforms === 'warn' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-red-100 text-red-700 border-red-200'}`}>
              {conforms === 'ok' ? 'âœ… CONFORME' : conforms === 'warn' ? 'âš ï¸ INDETERMINADO' : 'âŒ NO CONFORME'}
            </div>
          )}
        </div>
        {/* Budget */}
        <Card>
          <Hdg icon="ğŸ“Š" title="Presupuesto de incertidumbre â€” JCGM 100:2008" color="purple" />
          <div className="overflow-x-auto">
            <table className="w-full text-xs">
              <thead><tr className="border-b border-slate-100">
                {['Fuente','T.','u(xi) [mm]','ContribuciÃ³n'].map(h =>
                  <th key={h} className="text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider px-4 py-3">{h}</th>)}
              </tr></thead>
              <tbody>
                {g.comps.map((c, i) => (
                  <tr key={i} className="border-b border-slate-50">
                    <td className="px-4 py-2.5 text-slate-700">{c.name}</td>
                    <td className="px-4 py-2.5"><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${c.type === 'A' ? 'bg-blue-100 text-blue-700' : 'bg-teal-100 text-teal-700'}`}>{c.type}</span></td>
                    <td className="px-4 py-2.5 font-mono text-right">{fmt(c.u, 6)}</td>
                    <td className="px-4 py-2.5 w-48">
                      <div className="flex items-center gap-2">
                        <div className="flex-1 h-1.5 bg-slate-100 rounded-full"><div className={`h-full rounded-full ${c.type === 'A' ? 'bg-blue-400' : 'bg-teal-400'}`} style={{ width: `${c.pct}%` }} /></div>
                        <span className="w-8 text-right text-slate-500">{c.pct.toFixed(1)}%</span>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr className="bg-blue-50 border-t-2 border-blue-200">
                  <td colSpan={2} className="px-4 py-3 font-bold text-blue-800">U = {g.k.toFixed(3)} Ã— uc</td>
                  <td className="px-4 py-3 font-mono font-bold text-right text-blue-700">{fmt(g.U, 6)}</td>
                  <td />
                </tr>
              </tfoot>
            </table>
          </div>
        </Card>
        {/* Signature */}
        <Card>
          <Hdg icon="âœï¸" title="Firma del tÃ©cnico" color="slate" />
          <div className="p-5 flex gap-4 items-start">
            <div className="flex-1">
              <p className="text-xs text-slate-500 mb-2">Dibuja tu firma en el recuadro con el ratÃ³n.</p>
              <div className="border-2 border-dashed border-slate-200 rounded-xl overflow-hidden bg-white hover:border-blue-300 transition-colors cursor-crosshair">
                <canvas ref={canvasRef} width={380} height={90} className="block w-full"
                  onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw} />
              </div>
              <button onClick={() => { const c = canvasRef.current; c.getContext('2d').clearRect(0, 0, c.width, c.height); sv('signature', ''); }} className="mt-1.5 text-xs text-slate-400 hover:text-red-500 transition-colors">Ã— Borrar firma</button>
            </div>
            {s.signature && <img src={s.signature} alt="Firma" className="border border-slate-200 rounded-lg h-20 bg-white" />}
          </div>
        </Card>
        <div className="flex justify-between">
          <Btn variant="ghost" onClick={() => setStep(3)}>â† Mediciones</Btn>
          <div className="flex gap-2">
            <Btn variant="ghost" onClick={() => setStep(5)}>Ver certificado â†’</Btn>
            <Btn variant="success" onClick={() => doSave(s.gum)} icon="ğŸ’¾">Guardar y emitir</Btn>
          </div>
        </div>
      </div>
    );
  })()}
  {step === 4 && !s.gum && (
    <div className="p-8 text-center text-slate-400">Vuelve al paso de mediciones y pulsa "Calcular GUM".</div>
  )}

  {/* â”€â”€ STEP 5: CERT PREVIEW â”€â”€ */}
  {step === 5 && <CertPreview cal={{ ...s, techName: tech?.name || 'â€”', threadName: thread?.name || 'â€”' }} onBack={() => setStep(4)} />}
</div>
```

);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CERTIFICATE VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CalView({ cal, onBack, onRecal }) {
return (
<div className="space-y-4">
<div className="flex items-center gap-3">
<button onClick={onBack} className="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition-colors">â†</button>
<div>
<h2 className="font-bold text-slate-800">CalibraciÃ³n {cal.certNum}</h2>
<div className="flex items-center gap-2 mt-0.5">
<span className="text-xs text-slate-400">{cal.clientName} â†’ {cal.equipRef} Â· {fmtDate(cal.date)}</span>
<Badge color={cal.status === â€˜ISSUEDâ€™ ? â€˜greenâ€™ : â€˜amberâ€™}>{cal.status}</Badge>
</div>
</div>
<div className="ml-auto flex gap-2">
<Btn size="sm" variant="amber" onClick={onRecal} icon="ğŸ”„">Recalibrar</Btn>
</div>
</div>
<CertPreview cal={cal} onBack={onBack} />
</div>
);
}

function CertPreview({ cal, onBack }) {
const g = cal.gum;
const machines = DB.get(â€˜machinesâ€™) || MACHINE_SEED;
const machine = machines.find(m => m.id === cal.machineId);
const cfg = DB.get(â€˜configâ€™) || {};

if (!g) return <div className="p-8 text-center text-slate-400">Sin datos de cÃ¡lculo en esta calibraciÃ³n.</div>;

return (
<div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
{/* accent stripe */}
<div style={{ height: 4, background: â€˜linear-gradient(90deg, #2563eb, #0d9488)â€™ }} />
<div className="p-8 space-y-5">
{/* header */}
<div className="flex justify-between items-start border-b-2 border-slate-900 pb-5">
<div className="flex items-center gap-4">
{cfg.logoData && <img src={cfg.logoData} alt="Logo" className="h-12 object-contain" />}
<div>
<div className="font-black text-xl text-slate-900">{cal.labName || â€˜Laboratorio de MetrologÃ­aâ€™}</div>
<div className="text-xs text-slate-400 tracking-widest uppercase mt-0.5">Laboratorio Acreditado Â· ISO/IEC 17025:2017</div>
</div>
</div>
<div className="text-right">
<div className="bg-slate-900 text-white text-xs font-black px-3 py-1 rounded tracking-widest">ENAC</div>
<div className="text-[10px] text-slate-400 mt-1.5">EURAMET cg-10 Â· JCGM 100:2008</div>
</div>
</div>
<div className="text-center">
<div className="font-black text-2xl tracking-widest uppercase">Certificado de CalibraciÃ³n</div>
<div className="font-mono text-slate-500 mt-1">NÂº {cal.certNum}</div>
</div>
{/* Â§1 */}
<CertSection title="Â§1 IdentificaciÃ³n">
<KV label="NÂº Certificado" value={cal.certNum} />
<KV label="Fecha" value={fmtDate(cal.date)} />
<KV label="Cliente" value={cal.clientName} />
<KV label="Referencia equipo" value={cal.equipRef} />
<KV label="TÃ©cnico" value={cal.techName} />
</CertSection>
{/* Â§2 */}
<CertSection title="Â§2 Elemento calibrado">
<KV label="Rosca" value={cal.threadName} />
<KV label=â€œDirecciÃ³nâ€ value={cal.direction === â€˜externalâ€™ ? â€˜Tornillo (externo)â€™ : â€˜Tuerca (interno)â€™} />
<KV label=â€œClase toleranciaâ€ value={cal.tolClass || â€˜â€”â€™} />
<KV label=â€œMaterialâ€ value={Object.keys(MATERIALS).find(k => MATERIALS[k].alpha === +cal.alpha_th) || â€˜â€”â€™} />
</CertSection>
{/* Â§3 */}
<CertSection title="Â§3 Instrumento">
<KV label=â€œBancoâ€ value={machine ? `${machine.brand} ${machine.model}${machine.sn ? ` Â· SN: ${machine.sn}` : ''}` : â€˜â€”â€™} />
<KV label=â€œU cal banco (k=2)â€ value={machine ? `${machine.uCal} mm` : â€˜â€”â€™} />
<KV label=â€œHilo Wâ€ value={cal.wireDiam ? `${cal.wireDiam} mm Â· cert: ${cal.wireCert || 'â€”'}` : â€˜â€”â€™} />
<KV label=â€œTemperaturaâ€ value={`${cal.temp} Â°C (ref. 20.0 Â°C â€” ISO 1:2016)`} />
<KV label=â€œHumedadâ€ value={`${cal.humidity || 'â€”'} %`} />
</CertSection>
{/* Â§4 RESULT */}
<CertSection title="Â§4 Resultado">
<div className="col-span-2 bg-gradient-to-br from-blue-50 to-sky-50 border border-blue-200 rounded-xl p-5 text-center">
<div className="text-xs text-slate-400 mb-2 font-mono">DiÃ¡metro de paso E</div>
<div className="text-2xl font-black font-mono text-blue-800">E = ({g.mean.toFixed(5)} Â± {fmt(g.U)}) mm</div>
<div className="text-xs text-slate-400 mt-2">U = kÂ·uc Â· k = {g.k.toFixed(3)} Â· p â‰ˆ 95.45% Â· Î½eff = {g.nuEff < 1e9 ? g.nuEff.toFixed(1) : â€˜âˆâ€™}</div>
</div>
<KV label="n lecturas" value={g.n} />
<KV label=â€œMedia Ä’â€ value={`${g.mean.toFixed(7)} mm`} mono />
<KV label=â€œDesviaciÃ³n estÃ¡ndar sâ€ value={`${g.s.toExponential(3)} mm`} mono />
<KV label=â€œIncertidumbre combinada ucâ€ value={`${fmt(g.uc, 6)} mm`} mono />
</CertSection>
{/* Â§5 BUDGET */}
<div>
<div className="bg-slate-900 text-white text-[10px] font-black px-3 py-1.5 rounded-sm tracking-widest uppercase inline-block mb-3">Â§5 Presupuesto GUM â€” JCGM 100:2008</div>
<table className="w-full text-xs border border-slate-200 rounded-lg overflow-hidden">
<thead className="bg-slate-50">
<tr>{[â€˜Fuenteâ€™,â€˜Tipoâ€™,â€˜u(xi) mmâ€™,â€™%â€™].map(h => <th key={h} className="px-4 py-2 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wide">{h}</th>)}</tr>
</thead>
<tbody>
{g.comps.map((c, i) => (
<tr key={i} className="border-t border-slate-100">
<td className="px-4 py-2 text-slate-700">{c.name}</td>
<td className=â€œpx-4 py-2 font-boldâ€ style={{ color: c.type === â€˜Aâ€™ ? â€˜#1d4ed8â€™ : â€˜#0d9488â€™ }}>{c.type}</td>
<td className="px-4 py-2 font-mono text-right">{fmt(c.u, 6)}</td>
<td className="px-4 py-2 text-right">{c.pct.toFixed(1)}%</td>
</tr>
))}
<tr className="bg-blue-50 border-t-2 border-blue-200">
<td colSpan={2} className="px-4 py-2 font-black text-blue-900">U = {g.k.toFixed(3)} Ã— uc</td>
<td className="px-4 py-2 font-mono font-black text-right text-blue-700">{fmt(g.U, 6)}</td>
<td />
</tr>
</tbody>
</table>
</div>
{/* Â§6 */}
<CertSection title="Â§6 Trazabilidad">
<p className="col-span-2 text-sm text-slate-600 leading-relaxed">Las mediciones son trazables a patrones nacionales del CEM (Centro EspaÃ±ol de MetrologÃ­a) mediante cadena documentada: BIPM â†’ CEM â†’ Laboratorio acreditado ENAC â†’ Instrumento de mediciÃ³n.</p>
<p className="col-span-2 text-sm text-slate-600">MÃ©todo: EURAMET cg-10. Correcciones aplicadas: tÃ©rmica (ISO 1:2016) + deformaciÃ³n elÃ¡stica Hertz. Software: ThreadCal Pro v4.</p>
</CertSection>
{/* Signatures */}
<div className="flex justify-between items-end pt-6 border-t border-slate-200">
<div className="text-center">
{cal.signature ? <img src={cal.signature} alt="Firma" className="h-14 mb-2 mx-auto" /> : <div className=â€œw-36 border-t border-slate-400 mb-2 mx-autoâ€ style={{ marginTop: 40 }} />}
<div className="font-bold text-sm text-slate-800">{cal.techName || â€˜â€”â€™}</div>
<div className="text-xs text-slate-400">TÃ©cnico de calibraciÃ³n</div>
</div>
<div className="text-center text-xs text-slate-400 space-y-0.5">
<div className="font-mono">{cal.certNum}</div>
<div>{fmtDate(cal.date)}</div>
<div>ThreadCal Pro v4</div>
<div className="text-[10px]">VÃ¡lido sÃ³lo Ã­ntegramente</div>
</div>
<div className="text-center">
<div className=â€œw-36 border-t border-slate-400 mb-2 mx-autoâ€ style={{ marginTop: 40 }} />
<div className="font-bold text-sm text-slate-800">Responsable TÃ©cnico</div>
<div className="text-xs text-slate-400">RevisiÃ³n y aprobaciÃ³n</div>
</div>
</div>
</div>
</div>
);
}

const CertSection = ({ title, children }) => (

  <div>
    <div className="bg-slate-900 text-white text-[10px] font-black px-3 py-1.5 rounded-sm tracking-widest uppercase inline-block mb-3">{title}</div>
    <div className="grid grid-cols-2 gap-x-8 gap-y-1.5">{children}</div>
  </div>
);
const KV = ({ label, value, mono }) => (
  <div className="flex gap-3 text-sm border-b border-slate-50 pb-1.5">
    <span className="text-slate-400 w-44 flex-shrink-0">{label}:</span>
    <span className={`font-semibold text-slate-800 ${mono ? 'font-mono text-xs' : ''}`}>{value || 'â€”'}</span>
  </div>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ConfigSection() {
const [tab, setTab] = useState(â€˜labâ€™);
const tabs = [
{ id:â€˜labâ€™, l:â€˜Laboratorioâ€™, icon:â€˜ğŸ›ï¸â€™ },
{ id:â€˜machinesâ€™, l:â€˜Bancosâ€™, icon:â€˜ğŸ”§â€™ },
{ id:â€˜techsâ€™, l:â€˜TÃ©cnicosâ€™, icon:â€˜ğŸ‘·â€™ },
{ id:â€˜threadsâ€™, l:â€˜Roscasâ€™, icon:â€˜âš™ï¸â€™ },
{ id:â€˜wiresâ€™, l:â€˜Hilosâ€™, icon:â€˜ğŸ“â€™ },
{ id:â€˜formulasâ€™, l:â€˜FÃ³rmulasâ€™, icon:â€˜ğŸ“â€™ },
];
return (
<div className="space-y-4">
<div><h2 className="font-bold text-slate-800 text-lg">ConfiguraciÃ³n</h2><p className="text-xs text-slate-400 mt-0.5">Bancos, tÃ©cnicos, hilos, roscas y datos del laboratorio</p></div>
<div className="flex gap-1.5 border-b border-slate-200 pb-0">
{tabs.map(t => (
<button key={t.id} onClick={() => setTab(t.id)}
className={`flex items-center gap-1.5 px-4 py-2.5 text-sm font-semibold transition-all border-b-2 -mb-px ${tab === t.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>
<span>{t.icon}</span>{t.l}
</button>
))}
</div>
<div className="pt-2">
{tab === â€˜labâ€™ && <LabConfig />}
{tab === â€˜machinesâ€™ && <MachinesConfig />}
{tab === â€˜techsâ€™ && <TechsConfig />}
{tab === â€˜threadsâ€™ && <ThreadsConfig />}
{tab === â€˜wiresâ€™ && <WiresConfig />}
{tab === â€˜formulasâ€™ && <FormulasInfo />}
</div>
</div>
);
}

function LabConfig() {
const [cfg, setCfg] = useState(() => DB.get(â€˜configâ€™) || { labName:â€™â€™, address:â€™â€™, accred:â€™â€™, logoData:â€™â€™ });
const save = () => { DB.set(â€˜configâ€™, cfg); alert(â€˜âœ… ConfiguraciÃ³n guardadaâ€™); };
const F = (k,v) => setCfg(c => ({â€¦c,[k]:v}));
const handleLogo = (e) => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>F(â€˜logoDataâ€™,ev.target.result); r.readAsDataURL(f); };
return (
<div className="max-w-xl space-y-4">
<Card>
<Hdg icon="ğŸ›ï¸" title="Datos del laboratorio" sub="Aparecen en todos los certificados" />
<div className="p-5 space-y-3">
<Fld label="Nombre del laboratorio"><Inp value={cfg.labName} onChange={e=>F(â€˜labNameâ€™,e.target.value)} placeholder=â€œLaboratorio de MetrologÃ­a Dimensionalâ€ /></Fld>
<Fld label="DirecciÃ³n"><Inp value={cfg.address} onChange={e=>F(â€˜addressâ€™,e.target.value)} /></Fld>
<Fld label="NÂº AcreditaciÃ³n ENAC"><Inp value={cfg.accred} onChange={e=>F(â€˜accredâ€™,e.target.value)} placeholder=â€œENAC-I-XXX/LE-XXXâ€ /></Fld>
</div>
</Card>
<Card>
<Hdg icon="ğŸ–¼ï¸" title="Logo" sub="PNG, JPG o SVG â€” aparece en los certificados" color="teal" />
<div className="p-5 space-y-3">
<label className="flex items-center gap-3 p-4 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all">
<span className="text-2xl">ğŸ“</span>
<div><div className="font-semibold text-slate-700 text-sm">Cargar logo</div><div className="text-xs text-slate-400">PNG Â· JPG Â· SVG Â· mÃ¡x. 2MB</div></div>
<input type="file" accept="image/*" className="hidden" onChange={handleLogo} />
</label>
{cfg.logoData && (
<div className="flex items-center gap-4">
<img src={cfg.logoData} alt="Logo" className="h-14 object-contain border border-slate-200 rounded-lg p-2 bg-white" />
<button onClick={() => F(â€˜logoDataâ€™,â€™â€™)} className=â€œtext-xs text-red-500 hover:text-red-700â€>Ã— Eliminar logo</button>
</div>
)}
</div>
</Card>
<div className="flex justify-end"><Btn onClick={save} icon="ğŸ’¾">Guardar configuraciÃ³n</Btn></div>
</div>
);
}

function MachinesConfig() {
const [machines, setMachines] = useState(() => DB.get(â€˜machinesâ€™) || MACHINE_SEED);
const [modal, setModal] = useState(false);
const [editing, setEditing] = useState(null);
const [del, setDel] = useState(null);
const blank = { id:uid(), brand:â€™â€™, model:â€™â€™, sn:â€™â€™, uCal:0.0006, resolution:0.0001, force:4, forceUnit:â€˜cNâ€™, cert:â€™â€™, certDate:â€™â€™, certExpiry:â€™â€™, note:â€™â€™ };
const [form, setForm] = useState(blank);
const save = (m) => { DB.set(â€˜machinesâ€™, m); setMachines(m); };
const F = (k,v) => setForm(f=>({â€¦f,[k]:v}));
const submit = () => { save(editing ? machines.map(m=>m.id===editing?form:m) : [â€¦machines,form]); setModal(false); };
return (
<div className="space-y-4">
<div className="flex justify-between items-center">
<div><h3 className="font-bold text-slate-800">Bancos de mediciÃ³n</h3><p className="text-xs text-slate-400">MÃ¡quinas reutilizables en calibraciones</p></div>
<Btn onClick={()=>{setEditing(null);setForm({â€¦blank,id:uid()});setModal(true);}} icon=â€œâ•â€ size=â€œsmâ€>Nuevo banco</Btn>
</div>
<Card><Tbl cols={[{k:â€˜brandâ€™,l:â€˜Marcaâ€™,bold:true},{k:â€˜modelâ€™,l:â€˜Modeloâ€™,bold:true},{k:â€˜snâ€™,l:â€˜S/Nâ€™},{k:â€˜uCalâ€™,l:â€˜U(k=2) mmâ€™,mono:true},{k:â€˜forceâ€™,l:â€˜Fuerzaâ€™,mono:true},{k:â€˜certâ€™,l:â€˜Certificadoâ€™},{k:â€˜certExpiryâ€™,l:â€˜VÃ¡lido hastaâ€™}]}
rows={machines.map(m=>({â€¦m,force:`${m.force} ${m.forceUnit}`}))}
onEdit={row=>{const m=machines.find(x=>x.sn===row.sn&&x.model===row.model)||machines[0];setEditing(m.id);setForm({â€¦m});setModal(true);}}
onDel={row=>setDel(machines.find(x=>x.model===row.model))} empty=â€œSin bancos registradosâ€ /></Card>
<Modal open={modal} onClose={()=>setModal(false)} title={editing?â€˜Editar bancoâ€™:â€˜Nuevo bancoâ€™} wide>
<div className="grid grid-cols-2 gap-4">
<Fld label="Marca"><Inp value={form.brand} onChange={e=>F(â€˜brandâ€™,e.target.value)} /></Fld>
<Fld label="Modelo"><Inp value={form.model} onChange={e=>F(â€˜modelâ€™,e.target.value)} /></Fld>
<Fld label="NÂº serie"><Inp value={form.sn} onChange={e=>F(â€˜snâ€™,e.target.value)} /></Fld>
<Fld label="U cal (k=2)" unit="mm"><Inp type=â€œnumberâ€ value={form.uCal} onChange={e=>F(â€˜uCalâ€™,+e.target.value)} step=â€œ0.00001â€ /></Fld>
<Fld label="ResoluciÃ³n" unit="mm"><Inp type=â€œnumberâ€ value={form.resolution} onChange={e=>F(â€˜resolutionâ€™,+e.target.value)} step=â€œ0.00001â€ /></Fld>
<div className="flex gap-2">
<Fld label="Fuerza"><Inp type=â€œnumberâ€ value={form.force} onChange={e=>F(â€˜forceâ€™,+e.target.value)} step=â€œ0.01â€ /></Fld>
<Fld label="Unidad"><Sel value={form.forceUnit} onChange={e=>F(â€˜forceUnitâ€™,e.target.value)} className=â€!w-20â€><option>cN</option><option>N</option><option>daN</option></Sel></Fld>
</div>
<Fld label="Certificado"><Inp value={form.cert} onChange={e=>F(â€˜certâ€™,e.target.value)} /></Fld>
<Fld label="Fecha cal."><Inp type=â€œdateâ€ value={form.certDate} onChange={e=>F(â€˜certDateâ€™,e.target.value)} /></Fld>
<Fld label="VÃ¡lido hasta"><Inp type=â€œdateâ€ value={form.certExpiry} onChange={e=>F(â€˜certExpiryâ€™,e.target.value)} /></Fld>
<div className="col-span-2"><Fld label="Notas"><textarea className=â€œw-full text-sm px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-400 outline-none resize-none h-14â€ value={form.note} onChange={e=>F(â€˜noteâ€™,e.target.value)} /></Fld></div>
</div>
<div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={()=>setModal(false)}>Cancelar</Btn>
<Btn onClick={submit} icon="ğŸ’¾">{editing?â€˜Guardarâ€™:â€˜Crearâ€™}</Btn>
</div>
</Modal>
<Confirm open={!!del} msg={`Â¿Eliminar banco "${del?.model}"?`} onOk={()=>{save(machines.filter(m=>m.id!==del.id));setDel(null);}} onCancel={()=>setDel(null)} />
</div>
);
}

function TechsConfig() {
const [techs, setTechs] = useState(() => DB.get(â€˜techsâ€™) || []);
const [modal, setModal] = useState(false);
const [editing, setEditing] = useState(null);
const [del, setDel] = useState(null);
const blank = { id:uid(), code:â€™â€™, name:â€™â€™, role:â€˜TÃ©cnico de calibraciÃ³nâ€™, email:â€™â€™, qual:â€™â€™ };
const [form, setForm] = useState(blank);
const save = (t) => { DB.set(â€˜techsâ€™, t); setTechs(t); };
const F = (k,v) => setForm(f=>({â€¦f,[k]:v}));
const submit = () => { save(editing ? techs.map(t=>t.id===editing?form:t) : [â€¦techs,form]); setModal(false); };
return (
<div className="space-y-4">
<div className="flex justify-between items-center">
<div><h3 className="font-bold text-slate-800">TÃ©cnicos</h3><p className="text-xs text-slate-400">Personal habilitado para calibraciones</p></div>
<Btn onClick={()=>{setEditing(null);setForm({â€¦blank,id:uid()});setModal(true);}} icon=â€œâ•â€ size=â€œsmâ€>Nuevo tÃ©cnico</Btn>
</div>
<Card><Tbl cols={[{k:â€˜codeâ€™,l:â€˜CÃ³digoâ€™,bold:true},{k:â€˜nameâ€™,l:â€˜Nombreâ€™,bold:true},{k:â€˜roleâ€™,l:â€˜Rolâ€™},{k:â€˜qualâ€™,l:â€˜CualificaciÃ³nâ€™},{k:â€˜emailâ€™,l:â€˜Emailâ€™}]}
rows={techs} onEdit={row=>{setEditing(row.id);setForm({â€¦row});setModal(true);}} onDel={row=>setDel(row)} empty=â€œSin tÃ©cnicosâ€ /></Card>
<Modal open={modal} onClose={()=>setModal(false)} title={editing?â€˜Editar tÃ©cnicoâ€™:â€˜Nuevo tÃ©cnicoâ€™}>
<div className="grid grid-cols-2 gap-4">
<Fld label="CÃ³digo"><Inp value={form.code} onChange={e=>F(â€˜codeâ€™,e.target.value)} placeholder=â€œOP-001â€ /></Fld>
<Fld label="Nombre"><Inp value={form.name} onChange={e=>F(â€˜nameâ€™,e.target.value)} /></Fld>
<div className="col-span-2"><Fld label="Rol"><Inp value={form.role} onChange={e=>F(â€˜roleâ€™,e.target.value)} /></Fld></div>
<Fld label="CualificaciÃ³n"><Inp value={form.qual} onChange={e=>F(â€˜qualâ€™,e.target.value)} /></Fld>
<Fld label="Email"><Inp type=â€œemailâ€ value={form.email} onChange={e=>F(â€˜emailâ€™,e.target.value)} /></Fld>
</div>
<div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={()=>setModal(false)}>Cancelar</Btn>
<Btn onClick={submit} icon="ğŸ’¾">{editing?â€˜Guardarâ€™:â€˜Crearâ€™}</Btn>
</div>
</Modal>
<Confirm open={!!del} msg={`Â¿Eliminar tÃ©cnico "${del?.name}"?`} onOk={()=>{save(techs.filter(t=>t.id!==del.id));setDel(null);}} onCancel={()=>setDel(null)} />
</div>
);
}

function ThreadsConfig() {
const [filter, setFilter] = useState(â€™â€™);
const [stdFilter, setStdFilter] = useState(â€™â€™);
const [modal, setModal] = useState(false);
const [customThreads, setCustomThreads] = useState(() => DB.get(â€˜customThreadsâ€™) || []);
const blank = { id:uid(), std:â€˜CUSTOMâ€™, name:â€™â€™, d:â€™â€™, p:â€™â€™, d2:â€™â€™, d1:â€™â€™, alpha:60, tolExt:â€™â€™, tolInt:â€™â€™, norm:â€™â€™ };
const [form, setForm] = useState(blank);
const F = (k,v) => setForm(f=>({â€¦f,[k]:v}));
const allThreads = [â€¦THREADS, â€¦customThreads];
const filtered = allThreads.filter(t =>
(!stdFilter || t.std === stdFilter) &&
(!filter || t.name.toLowerCase().includes(filter.toLowerCase()))
);
const submit = () => {
const upd = [â€¦customThreads, form];
DB.set(â€˜customThreadsâ€™, upd); setCustomThreads(upd); setModal(false);
};
const stdColor = { M:â€˜blueâ€™, UNC:â€˜tealâ€™, UNF:â€˜tealâ€™, BSW:â€˜amberâ€™, BSF:â€˜amberâ€™, Tr:â€˜purpleâ€™, ACME:â€˜redâ€™, NPT:â€˜greenâ€™, BSPP:â€˜greenâ€™, BSPT:â€˜greenâ€™, CUSTOM:â€˜slateâ€™ };
return (
<div className="space-y-4">
<div className="flex items-center justify-between">
<div><h3 className="font-bold text-slate-800">Base de datos de roscas</h3><p className="text-xs text-slate-400">{THREADS.length} roscas precargadas Â· {customThreads.length} personalizadas</p></div>
<Btn onClick={()=>{setForm({â€¦blank,id:uid()});setModal(true);}} icon=â€œâ•â€ size=â€œsmâ€>AÃ±adir rosca</Btn>
</div>
<div className="flex gap-3">
<input className=â€œflex-1 text-sm px-3 py-2 rounded-lg border border-slate-200 bg-white focus:border-blue-400 outline-noneâ€ placeholder=â€œBuscar roscaâ€¦â€ value={filter} onChange={e=>setFilter(e.target.value)} />
<Sel value={stdFilter} onChange={e=>setStdFilter(e.target.value)} className=â€œw-44â€>
<option value="">Todas las normas</option>
{THREAD_STANDARDS.filter(s=>s.id!==â€˜CUSTOMâ€™).map(s=><option key={s.id} value={s.id}>{s.label}</option>)}
</Sel>
</div>
<Card>
<Tbl cols={[
{k:â€˜stdBâ€™,l:â€˜Normaâ€™},{k:â€˜nameâ€™,l:â€˜DesignaciÃ³nâ€™,bold:true},
{k:â€˜dâ€™,l:â€˜D [mm]â€™,mono:true},{k:â€˜pâ€™,l:â€˜p [mm]â€™,mono:true},{k:â€˜d2â€™,l:â€˜d2 [mm]â€™,mono:true},
{k:â€˜alphaâ€™,l:â€˜Î± [Â°]â€™,mono:true},{k:â€˜tolExtâ€™,l:â€˜Tol.Extâ€™,mono:true},{k:â€˜tolIntâ€™,l:â€˜Tol.Intâ€™,mono:true},
]} rows={filtered.map(t=>({
â€¦t,
stdB: <Badge color={stdColor[t.std]||â€˜slateâ€™}>{t.std}</Badge>,
d: (+t.d).toFixed(3), p: (+t.p).toFixed(3), d2: (+t.d2).toFixed(4),
_raw: t,
}))} empty=â€œSin resultadosâ€ />
</Card>
<Modal open={modal} onClose={()=>setModal(false)} title=â€œNueva rosca personalizadaâ€>
<div className="grid grid-cols-2 gap-4">
<Fld label="DesignaciÃ³n"><Inp value={form.name} onChange={e=>F(â€˜nameâ€™,e.target.value)} placeholder=â€œM14Ã—1.5-CUSTOMâ€ /></Fld>
<Fld label="Norma"><Inp value={form.norm} onChange={e=>F(â€˜normâ€™,e.target.value)} placeholder=â€œISO / DIN / ASMEâ€¦â€ /></Fld>
<Fld label="D nominal" unit="mm"><Inp type=â€œnumberâ€ value={form.d} onChange={e=>F(â€˜dâ€™,+e.target.value)} step=â€œ0.001â€ /></Fld>
<Fld label="Paso p" unit="mm"><Inp type=â€œnumberâ€ value={form.p} onChange={e=>F(â€˜pâ€™,+e.target.value)} step=â€œ0.001â€ /></Fld>
<Fld label="d2 (paso)" unit="mm"><Inp type=â€œnumberâ€ value={form.d2} onChange={e=>F(â€˜d2â€™,+e.target.value)} step=â€œ0.0001â€ /></Fld>
<Fld label="d1 (menor)" unit="mm"><Inp type=â€œnumberâ€ value={form.d1} onChange={e=>F(â€˜d1â€™,+e.target.value)} step=â€œ0.0001â€ /></Fld>
<Fld label="Ãngulo Î±" unit="Â°"><Inp type=â€œnumberâ€ value={form.alpha} onChange={e=>F(â€˜alphaâ€™,+e.target.value)} step=â€œ0.5â€ /></Fld>
<Fld label="Tolerancia ext."><Inp value={form.tolExt} onChange={e=>F(â€˜tolExtâ€™,e.target.value)} /></Fld>
</div>
<div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={()=>setModal(false)}>Cancelar</Btn>
<Btn onClick={submit} icon="ğŸ’¾">AÃ±adir rosca</Btn>
</div>
</Modal>
</div>
);
}

function WiresConfig() {
const [userWires, setUserWires] = useState(() => DB.get(â€˜userWiresâ€™) || []);
const [modal, setModal] = useState(false);
const [editing, setEditing] = useState(null);
const blank = { id:uid(), code:â€™â€™, diam:â€™â€™, uW:0.0002, cert:â€™â€™, certExpiry:â€™â€™, pMin:â€™â€™, pMax:â€™â€™, note:â€™â€™ };
const [form, setForm] = useState(blank);
const allWires = [â€¦WIRES, â€¦userWires];
const save = (w) => { DB.set(â€˜userWiresâ€™, w); setUserWires(w); };
const F = (k,v) => setForm(f=>({â€¦f,[k]:v}));
const submit = () => {
const upd = editing ? userWires.map(w=>w.id===editing?form:w) : [â€¦userWires,form];
save(upd); setModal(false);
};
return (
<div className="space-y-4">
<div className="flex items-center justify-between">
<div><h3 className="font-bold text-slate-800">Hilos de mediciÃ³n</h3><p className="text-xs text-slate-400">{WIRES.length} hilos ISO estÃ¡ndar precargados Â· {userWires.length} personalizados</p></div>
<Btn onClick={()=>{setEditing(null);setForm({â€¦blank,id:uid()});setModal(true);}} icon=â€œâ•â€ size=â€œsmâ€>AÃ±adir hilo</Btn>
</div>
<Card>
<Tbl cols={[
{k:â€˜codeâ€™,l:â€˜CÃ³digoâ€™,bold:true},{k:â€˜diamâ€™,l:â€˜W [mm]â€™,mono:true},
{k:â€˜uWâ€™,l:â€˜u(W) k=1â€™,mono:true},{k:â€˜certâ€™,l:â€˜Certificadoâ€™},
{k:â€˜pMinâ€™,l:â€˜p mÃ­nâ€™,mono:true},{k:â€˜pMaxâ€™,l:â€˜p mÃ¡xâ€™,mono:true},{k:â€˜noteâ€™,l:â€˜AplicaciÃ³nâ€™},
]} rows={allWires.map(w=>({â€¦w,diam:w.diam.toFixed(5)}))}
onEdit={row=>{const w=userWires.find(x=>x.code===row.code);if(w){setEditing(w.id);setForm({â€¦w});setModal(true);}}}
onDel={row=>{const w=userWires.find(x=>x.code===row.code);if(w)save(userWires.filter(x=>x.id!==w.id));}}
empty=â€œSin hilosâ€ />
</Card>
<Modal open={modal} onClose={()=>setModal(false)} title={editing?â€˜Editar hiloâ€™:â€˜Nuevo hiloâ€™} wide>
<div className="grid grid-cols-3 gap-4">
<Fld label="CÃ³digo"><Inp value={form.code} onChange={e=>F(â€˜codeâ€™,e.target.value)} placeholder=â€œW-0.866â€ /></Fld>
<Fld label="DiÃ¡metro W" unit="mm"><Inp type=â€œnumberâ€ value={form.diam} onChange={e=>F(â€˜diamâ€™,+e.target.value)} step=â€œ0.00001â€ /></Fld>
<Fld label="u(W) k=1" unit="mm"><Inp type=â€œnumberâ€ value={form.uW} onChange={e=>F(â€˜uWâ€™,+e.target.value)} step=â€œ0.00001â€ /></Fld>
<Fld label="Certificado"><Inp value={form.cert} onChange={e=>F(â€˜certâ€™,e.target.value)} /></Fld>
<Fld label="VÃ¡lido hasta"><Inp type=â€œdateâ€ value={form.certExpiry} onChange={e=>F(â€˜certExpiryâ€™,e.target.value)} /></Fld>
<Fld label="p mÃ­n" unit="mm"><Inp type=â€œnumberâ€ value={form.pMin} onChange={e=>F(â€˜pMinâ€™,+e.target.value)} step=â€œ0.01â€ /></Fld>
<Fld label="p mÃ¡x" unit="mm"><Inp type=â€œnumberâ€ value={form.pMax} onChange={e=>F(â€˜pMaxâ€™,+e.target.value)} step=â€œ0.01â€ /></Fld>
<div className="col-span-3"><Fld label="Nota / aplicaciÃ³n"><Inp value={form.note} onChange={e=>F(â€˜noteâ€™,e.target.value)} /></Fld></div>
</div>
<div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
<Btn variant=â€œghostâ€ onClick={()=>setModal(false)}>Cancelar</Btn>
<Btn onClick={submit} icon="ğŸ’¾">{editing?â€˜Guardarâ€™:â€˜AÃ±adir hiloâ€™}</Btn>
</div>
</Modal>
</div>
);
}

function FormulasInfo() {
const sections = [
{ title:â€˜EURAMET cg-10 â€” Tres Hilosâ€™, color:â€™#2563ebâ€™, items:[
{ f:â€˜E = M âˆ’ WÂ·(1 + 1/sin(Î±/2)) + p / (2Â·tan(Î±/2))â€™, d:â€˜DiÃ¡metro de paso a partir de la lectura del banco. M=lectura, W=diÃ¡m. hilo, Î±=Ã¡ngulo flanco, p=paso.â€™ },
{ f:â€˜Para Î±=60Â° (ISO): E = M âˆ’ 3Â·W + 0.86603Â·pâ€™, d:â€˜SimplificaciÃ³n directa para roscas MÃ©tricas ISO.â€™ },
{ f:â€˜W_opt = p / (2Â·cos(Î±/2))â€™, d:â€˜Hilo Ã³ptimo. Para Î±=60Â°: W = p/âˆš3 â‰ˆ 0.5774Â·pâ€™ },
{ f:â€˜0.56Â·p â‰¤ W â‰¤ 0.90Â·pâ€™, d:â€˜Rango vÃ¡lido de hilos para contacto correcto en el flanco.â€™ },
]},
{ title:â€˜CorrecciÃ³n TÃ©rmica â€” ISO 1:2016â€™, color:â€™#d97706â€™, items:[
{ f:â€˜Î”M = âˆ’M Â· Î±_th Â· (T âˆ’ 20Â°C)â€™, d:â€˜T_ref = 20 Â°C. Î±_th = coef. dilataciÃ³n material (Kâ»Â¹).â€™ },
{ f:â€˜M_th = M + Î”Mâ€™, d:â€˜M corregida por temperatura antes de aplicar Hertz.â€™ },
]},
{ title:â€˜CorrecciÃ³n de Hertzâ€™, color:â€™#0d9488â€™, items:[
{ f:â€˜Î´_H = 2Â·[3F/(4E*)]^(2/3)Â·(1/R)^(1/3)â€™, d:â€˜F=fuerza(N), R=radio hilo(m), E*=mÃ³dulo reducido(Pa).â€™ },
{ f:â€˜E* = E_mat / (2Â·(1âˆ’Î½Â²))â€™, d:â€˜MÃ³dulo reducido de contacto elÃ¡stico.â€™ },
{ f:â€˜M_c = M_th âˆ’ Î´_Hâ€™, d:â€˜Lectura final corregida tÃ©rmica y elÃ¡sticamente.â€™ },
]},
{ title:â€˜GUM â€” JCGM 100:2008â€™, color:â€™#7c3aedâ€™, items:[
{ f:â€˜u_A1 = s/âˆšnâ€™, d:â€˜Tipo A. s=desv.est. lecturas E, n=nÃºmero de lecturas.â€™ },
{ f:â€˜u_A2 = |Ä’_0Â° âˆ’ Ä’_90Â°|/âˆš2â€™, d:â€˜Tipo A. VariaciÃ³n entre planos de mediciÃ³n.â€™ },
{ f:â€˜u_B1 = U_cal/k_calâ€™, d:â€˜Tipo B. Incertidumbre certificado banco (k_cal=2).â€™ },
{ f:â€˜u_B2 = r/(2âˆš3)â€™, d:â€˜Tipo B. ResoluciÃ³n encoder. DistribuciÃ³n rectangular.â€™ },
{ f:â€˜u_B3 = |c_W|Â·u(W), c_W = âˆ’(1+1/sin(Î±/2))â€™, d:â€˜Tipo B. Sensibilidad al diÃ¡metro del hilo.â€™ },
{ f:â€˜u_c = âˆš[Î£(u_i)Â²]â€™, d:â€˜Incertidumbre combinada. PropagaciÃ³n cuadrÃ¡tica.â€™ },
{ f:â€˜Î½_eff = u_câ´ / Î£[u_iâ´/Î½_i]â€™, d:â€˜Welch-Satterthwaite. Grados de libertad efectivos.â€™ },
{ f:â€˜U = kÂ·u_c  (k â‰ˆ 2.00 para Î½_eff â‰¥ 30)â€™, d:â€˜Incertidumbre expandida al 95.45%.â€™ },
]},
{ title:â€˜Conformidad â€” JCGM 106:2012â€™, color:â€™#059669â€™, items:[
{ f:â€˜CONFORME: [Ä’âˆ’U, Ä’+U] âŠ† [T_inf, T_sup]â€™, d:â€˜Intervalo completo dentro de tolerancia.â€™ },
{ f:â€˜NO CONFORME: Ä’ âˆ‰ [T_inf, T_sup]â€™, d:â€˜Valor nominal fuera de tolerancia.â€™ },
{ f:â€˜INDETERMINADO: Ä’ âˆˆ T pero intervalo solapa fronteraâ€™, d:â€˜Requiere anÃ¡lisis adicional (JCGM 106 Â§6).â€™ },
]},
];
return (
<div className="space-y-4 max-w-3xl">
<div className="bg-emerald-50 border border-emerald-100 rounded-xl p-4 text-sm text-emerald-800">
<strong>Conformidad normativa:</strong> EURAMET cg-10 Â· JCGM 100:2008 (GUM) Â· ISO 1:2016 Â· ISO/IEC 17025:2017 Â· JCGM 106:2012
</div>
{sections.map(sec => (
<Card key={sec.title}>
<Hdg icon="ğŸ“" title={sec.title} />
<div className="divide-y divide-slate-50">
{sec.items.map((item, i) => (
<div key={i} className="p-4">
<div className=â€œfont-mono text-sm rounded-lg px-4 py-3 mb-2 overflow-x-auto whitespace-nowrapâ€ style={{ background:â€™#0f172aâ€™, color:â€™#34d399â€™ }}>
{item.f}
</div>
{item.d && <p className="text-xs text-slate-500">{item.d}</p>}
</div>
))}
</div>
</Card>
))}
</div>
);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP ROOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NAV = [
{ id:â€˜clientsâ€™, label:â€˜Clientesâ€™, icon:â€˜ğŸ­â€™, sub:â€˜Equipos Â· Calibracionesâ€™ },
{ id:â€˜configâ€™,  label:â€˜ConfiguraciÃ³nâ€™, icon:â€˜âš™ï¸â€™, sub:â€˜Bancos Â· TÃ©cnicos Â· Roscas Â· Hilosâ€™ },
];

const AppMain = function App() {
const [section, setSection] = useState(â€˜clientsâ€™);
const cfg = DB.get(â€˜configâ€™) || {};

return (
<div className=â€œmin-h-screen bg-slate-50 flexâ€ style={{ fontFamily: â€œâ€˜system-uiâ€™, sans-serifâ€ }}>
{/* SIDEBAR */}
<aside className="w-52 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 shadow-sm">
{/* Brand */}
<div className="px-4 py-5 border-b border-slate-100">
<div className="flex items-center gap-2.5">
{cfg.logoData
? <img src={cfg.logoData} alt="Logo" className="h-8 w-8 object-contain rounded-lg" />
: <div className=â€œw-9 h-9 rounded-xl flex items-center justify-center text-white font-black text-sm shadow-smâ€ style={{ background: â€˜linear-gradient(135deg,#2563eb,#0d9488)â€™ }}>TC</div>
}
<div>
<div className="font-black text-slate-900 text-sm tracking-tight">ThreadCal</div>
<div className="font-black text-blue-600 text-sm tracking-tight">Pro v4</div>
</div>
</div>
<div className="flex gap-1 mt-2.5 flex-wrap">
{[â€˜ISO 17025â€™,â€˜EURAMETâ€™,â€˜GUMâ€™].map(b => (
<span key={b} className="text-[9px] font-bold px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-600">{b}</span>
))}
</div>
</div>
{/* Nav */}
<nav className="flex-1 py-3 px-2 space-y-0.5">
{NAV.map(n => (
<button key={n.id} onClick={() => setSection(n.id)}
className={`w-full text-left flex items-start gap-2.5 px-3 py-3 rounded-xl transition-all ${section === n.id ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'}`}>
<span className="text-lg flex-shrink-0 mt-0.5">{n.icon}</span>
<div>
<div className={`text-sm font-bold leading-tight ${section === n.id ? 'text-blue-700' : 'text-slate-700'}`}>{n.label}</div>
<div className="text-[10px] text-slate-400 mt-0.5 leading-tight">{n.sub}</div>
</div>
</button>
))}
</nav>
<div className="px-4 py-3 border-t border-slate-100">
<div className="text-[10px] text-slate-400 leading-relaxed">
Datos en memoria de sesiÃ³n<br />
<span className="text-amber-500 font-semibold">âš¡ Modo demo</span>
</div>
</div>
</aside>

```
  {/* MAIN */}
  <main className="flex-1 overflow-y-auto min-h-screen">
    <div className="max-w-6xl mx-auto px-6 py-6">
      {section === 'clients' && <ClientsSection />}
      {section === 'config' && <ConfigSection />}
    </div>
  </main>
</div>
```

);
}

ReactDOM.createRoot(document.getElementById(â€œrootâ€)).render(React.createElement(AppMain));
</script>

</body>
</html>